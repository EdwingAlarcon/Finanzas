<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Finanzas Personales</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Panel de finanzas personales para gestionar ingresos, gastos y ahorros">
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Finanzas">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    
    <!-- Chart.js CDN - Carga diferida para mejor rendimiento -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <!-- jsPDF para generaci贸n de reportes PDF - Carga diferida -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js" defer></script>
    
    <!-- ==================== ESTILOS CSS ==================== -->
    <style>
        /* === Variables de tema (CSS Custom Properties) === */
        :root {
            /* Colores del tema claro (por defecto) */
            --color-fondo: #e8eaef;
            --color-fondo-tarjeta: #ffffff;
            --color-fondo-secundario: #f5f6f8;
            --color-texto: #333333;
            --color-texto-secundario: #666666;
            --color-texto-terciario: #999999;
            --color-borde: #d0d0d0;
            --color-borde-claro: #e5e5e5;
            --color-primario: #667eea;
            --color-primario-fin: #764ba2;
            --color-exito: #27ae60;
            --color-peligro: #e74c3c;
            --color-info: #3498db;
            --color-advertencia: #f39c12;
            --color-ahorro: #9b59b6;
            --sombra-tarjeta: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            --sombra-tarjeta-hover: 0 4px 8px rgba(0, 0, 0, 0.15), 0 12px 24px rgba(0, 0, 0, 0.15);
            --borde-tarjeta: 1px solid rgba(0, 0, 0, 0.08);
            --gradiente-primario: linear-gradient(135deg, var(--color-primario) 0%, var(--color-primario-fin) 100%);
        }

        /* Tema Oscuro */
        [data-tema="oscuro"] {
            --color-fondo: #1a1a2e;
            --color-fondo-tarjeta: #16213e;
            --color-fondo-secundario: #1f2940;
            --color-texto: #e8e8e8;
            --color-texto-secundario: #b0b0b0;
            --color-texto-terciario: #808080;
            --color-borde: #2d3a4f;
            --color-borde-claro: #253040;
            --color-primario: #7c8ce8;
            --color-primario-fin: #9b6dcc;
            --sombra-tarjeta: 0 2px 8px rgba(0, 0, 0, 0.3), 0 4px 16px rgba(0, 0, 0, 0.25);
            --sombra-tarjeta-hover: 0 4px 12px rgba(0, 0, 0, 0.4), 0 8px 24px rgba(0, 0, 0, 0.35);
            --borde-tarjeta: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Tema Verde Naturaleza */
        [data-tema="naturaleza"] {
            --color-fondo: #d5e5db;
            --color-fondo-tarjeta: #ffffff;
            --color-fondo-secundario: #e8f5e9;
            --color-texto: #1a3528;
            --color-texto-secundario: #3d5a4a;
            --color-texto-terciario: #5a7d68;
            --color-borde: #a5d6a7;
            --color-borde-claro: #c8e6c9;
            --color-primario: #2e7d32;
            --color-primario-fin: #1b5e20;
            --sombra-tarjeta: 0 2px 4px rgba(30, 80, 40, 0.15), 0 8px 16px rgba(30, 80, 40, 0.12);
            --sombra-tarjeta-hover: 0 4px 8px rgba(30, 80, 40, 0.2), 0 12px 24px rgba(30, 80, 40, 0.18);
            --borde-tarjeta: 1px solid rgba(46, 125, 50, 0.15);
        }

        /* Tema Oc茅ano */
        [data-tema="oceano"] {
            --color-fondo: #d4e8f7;
            --color-fondo-tarjeta: #ffffff;
            --color-fondo-secundario: #e1f5fe;
            --color-texto: #1a365d;
            --color-texto-secundario: #2c5282;
            --color-texto-terciario: #4a7ab0;
            --color-borde: #90caf9;
            --color-borde-claro: #bbdefb;
            --color-primario: #1565c0;
            --color-primario-fin: #0d47a1;
            --sombra-tarjeta: 0 2px 8px rgba(21, 101, 192, 0.1), 0 4px 16px rgba(21, 101, 192, 0.08);
            --sombra-tarjeta-hover: 0 4px 12px rgba(21, 101, 192, 0.15), 0 8px 24px rgba(21, 101, 192, 0.12);
            --borde-tarjeta: 1px solid rgba(21, 101, 192, 0.1);
        }

        /* === Reset y estilos base === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* === Screen Reader Only (Accesibilidad) === */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* === Contenedor principal === */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === Encabezado === */
        header {
            text-align: center;
            padding: 40px 20px;
            background: var(--gradiente-primario);
            color: white;
            border-radius: 0 0 20px 20px;
            margin-bottom: 30px;
            position: relative;
        }

        /* === Selector de tema === */
        .tema-selector {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tema-selector label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .tema-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            padding: 0;
        }

        .tema-btn:hover {
            transform: scale(1.1);
            border-color: white;
        }

        .tema-btn.activo {
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .tema-btn[data-tema-valor="claro"] {
            background: #f5f5f5;
        }

        .tema-btn[data-tema-valor="oscuro"] {
            background: #1a1a2e;
        }

        .tema-btn[data-tema-valor="naturaleza"] {
            background: #2e7d32;
        }

        .tema-btn[data-tema-valor="oceano"] {
            background: #1565c0;
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* === Secci贸n de resumen (tarjetas) === */
        .resumen {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tarjeta {
            background: var(--color-fondo-tarjeta);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--sombra-tarjeta);
            border: var(--borde-tarjeta);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }

        .tarjeta:hover {
            transform: translateY(-5px);
            box-shadow: var(--sombra-tarjeta-hover);
        }

        .tarjeta h3 {
            font-size: 0.9rem;
            color: var(--color-texto-secundario);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tarjeta .monto {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .tarjeta .subtexto {
            font-size: 0.8rem;
            color: var(--color-texto-terciario);
            margin-top: 5px;
        }

        .tarjeta.ingresos .monto { color: var(--color-exito); }
        .tarjeta.gastos .monto { color: var(--color-peligro); }
        .tarjeta.balance .monto { color: var(--color-info); }
        .tarjeta.balance .monto.negativo { color: var(--color-peligro); }
        .tarjeta.ahorro .monto { color: var(--color-ahorro); }
        .tarjeta.transacciones .monto { color: var(--color-advertencia); }

        .tarjeta .icono {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* === Secciones generales === */
        section {
            background: var(--color-fondo-tarjeta);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--sombra-tarjeta);
            border: var(--borde-tarjeta);
            transition: background-color 0.3s ease;
        }

        section h2 {
            font-size: 1.3rem;
            color: var(--color-texto);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-borde-claro);
        }

        /* === Formulario de registro === */
        .formulario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .campo {
            display: flex;
            flex-direction: column;
        }

        .campo label {
            font-size: 0.85rem;
            color: var(--color-texto-secundario);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .campo input,
        .campo select,
        .campo textarea {
            padding: 12px 15px;
            border: 2px solid var(--color-borde);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            font-family: inherit;
            background-color: var(--color-fondo-tarjeta);
            color: var(--color-texto);
        }

        .campo input:focus,
        .campo select:focus,
        .campo textarea:focus {
            outline: none;
            border-color: var(--color-primario);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .campo textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* === Campo con bot贸n inline === */
        .campo-con-boton {
            display: flex;
            gap: 10px;
        }

        .campo-con-boton input,
        .campo-con-boton select {
            flex: 1;
        }

        .campo-con-boton .btn {
            padding: 12px 15px;
            white-space: nowrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primario {
            background: var(--gradiente-primario);
            color: white;
        }

        .btn-primario:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secundario {
            background: var(--color-fondo-secundario);
            color: var(--color-texto-secundario);
        }

        .btn-secundario:hover {
            background: var(--color-borde);
        }

        .btn-exito {
            background: var(--color-exito);
            color: white;
        }

        .btn-exito:hover {
            opacity: 0.9;
        }

        .btn-eliminar {
            background: rgba(231, 76, 60, 0.1);
            color: var(--color-peligro);
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-eliminar:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        .btn-editar {
            background: rgba(52, 152, 219, 0.1);
            color: var(--color-info);
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-editar:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        .btn-pequeno {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .btn-icon {
            padding: 10px;
            font-size: 1.2rem;
            line-height: 1;
        }

        /* === Grupo de botones === */
        .btn-grupo {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* === Filtros === */
        .filtros {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filtros .campo {
            min-width: 150px;
        }

        /* === Tabla de movimientos === */
        .tabla-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--color-fondo-secundario);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-borde);
        }

        th {
            font-weight: 600;
            color: var(--color-texto-secundario);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s ease;
        }

        th:hover {
            background: var(--color-borde);
        }

        th.ordenado {
            color: var(--color-primario);
        }

        th .flecha {
            margin-left: 5px;
            font-size: 0.7rem;
        }

        tbody tr {
            transition: background 0.3s ease;
        }

        tbody tr:hover {
            background: var(--color-fondo-secundario);
        }

        .tipo-ingreso {
            color: var(--color-exito);
            font-weight: 600;
        }

        .tipo-gasto {
            color: var(--color-peligro);
            font-weight: 600;
        }

        .tipo-ahorro {
            color: var(--color-ahorro);
            font-weight: 600;
        }

        .monto-positivo {
            color: var(--color-exito);
            font-weight: 600;
        }

        .monto-negativo {
            color: var(--color-peligro);
            font-weight: 600;
        }

        .monto-ahorro {
            color: var(--color-ahorro);
            font-weight: 600;
        }

        .sin-datos {
            text-align: center;
            padding: 40px;
            color: var(--color-texto-terciario);
        }

        .acciones-celda {
            display: flex;
            gap: 5px;
        }

        /* === Secci贸n de objetivo de ahorro === */
        .objetivo-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            align-items: center;
        }

        .objetivo-input {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .progreso-container {
            padding: 20px;
            background: var(--color-fondo-secundario);
            border-radius: 10px;
        }

        .progreso-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--color-texto-secundario);
        }

        .progreso-barra {
            height: 20px;
            background: var(--color-borde);
            border-radius: 10px;
            overflow: hidden;
        }

        .progreso-relleno {
            height: 100%;
            background: var(--gradiente-primario);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .progreso-porcentaje {
            text-align: center;
            margin-top: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primario);
        }

        /* === Resumen por categor铆as === */
        .categorias-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .categoria-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--color-fondo-secundario);
            border-radius: 10px;
            gap: 15px;
        }

        .categoria-icono {
            font-size: 1.5rem;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-fondo-tarjeta);
            border-radius: 10px;
        }

        .categoria-info {
            flex: 1;
        }

        .categoria-nombre {
            font-weight: 600;
            color: var(--color-texto);
            margin-bottom: 5px;
        }

        .categoria-barra {
            height: 8px;
            background: var(--color-borde);
            border-radius: 4px;
            overflow: hidden;
        }

        .categoria-barra-relleno {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .categoria-barra-relleno.ingreso {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }

        .categoria-barra-relleno.gasto {
            background: linear-gradient(90deg, #e74c3c, #ec7063);
        }

        .categoria-monto {
            font-weight: 700;
            font-size: 1.1rem;
            text-align: right;
            min-width: 100px;
        }

        .categoria-monto.ingreso { color: var(--color-exito); }
        .categoria-monto.gasto { color: var(--color-peligro); }

        /* === Gesti贸n de categor铆as === */
        .categorias-personalizadas {
            margin-top: 20px;
            padding: 20px;
            background: var(--color-fondo-secundario);
            border-radius: 10px;
        }

        .categorias-personalizadas h4 {
            margin-bottom: 15px;
            color: var(--color-texto-secundario);
        }

        .lista-categorias {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tag-categoria {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: var(--color-fondo-tarjeta);
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid var(--color-borde);
        }

        .tag-categoria.ingreso {
            border-color: var(--color-exito);
            color: var(--color-exito);
        }

        .tag-categoria.gasto {
            border-color: var(--color-peligro);
            color: var(--color-peligro);
        }

        .tag-categoria .eliminar-tag {
            cursor: pointer;
            font-size: 1.1rem;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .tag-categoria .eliminar-tag:hover {
            opacity: 1;
        }

        .agregar-categoria-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .agregar-categoria-form .campo {
            min-width: 150px;
        }

        /* === Modal === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.activo {
            display: flex;
        }

        .modal {
            background: var(--color-fondo-tarjeta);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--color-texto);
        }

        .modal-botones {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* === Mensaje de estado === */
        .mensaje {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .mensaje.exito {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .mensaje.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        /* === Herramientas / Exportar === */
        .herramientas {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        /* === Gr谩ficos === */
        .graficos-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .grafico-wrapper {
            background: var(--color-fondo-secundario);
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
        }

        .grafico-wrapper h4 {
            margin-bottom: 15px;
            color: var(--color-texto);
            font-size: 1rem;
        }

        .grafico-canvas {
            max-height: 250px;
        }

        /* === Selector de Per铆odo === */
        .periodo-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .periodo-selector select {
            padding: 8px 15px;
            border: 2px solid var(--color-borde);
            border-radius: 8px;
            background: var(--color-fondo-tarjeta);
            color: var(--color-texto);
            font-size: 0.9rem;
        }

        .periodo-selector label {
            color: var(--color-texto-secundario);
            font-weight: 500;
        }

        /* === Presupuestos === */
        .presupuestos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .presupuesto-item {
            background: var(--color-fondo-secundario);
            border-radius: 10px;
            padding: 15px;
        }

        .presupuesto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .presupuesto-categoria {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--color-texto);
        }

        .presupuesto-valores {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 8px;
            color: var(--color-texto-secundario);
        }

        .presupuesto-barra {
            height: 10px;
            background: var(--color-borde);
            border-radius: 5px;
            overflow: hidden;
        }

        .presupuesto-barra-relleno {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .presupuesto-barra-relleno.normal {
            background: linear-gradient(90deg, var(--color-exito), #2ecc71);
        }

        .presupuesto-barra-relleno.advertencia {
            background: linear-gradient(90deg, var(--color-advertencia), #f1c40f);
        }

        .presupuesto-barra-relleno.excedido {
            background: linear-gradient(90deg, var(--color-peligro), #ec7063);
        }

        .presupuesto-estado {
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 500;
        }

        .presupuesto-estado.normal { color: var(--color-exito); }
        .presupuesto-estado.advertencia { color: var(--color-advertencia); }
        .presupuesto-estado.excedido { color: var(--color-peligro); }

        .agregar-presupuesto-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--color-borde);
        }

        /* === Movimientos Recurrentes === */
        .recurrentes-lista {
            display: grid;
            gap: 10px;
        }

        .recurrente-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--color-fondo-secundario);
            border-radius: 10px;
            gap: 15px;
        }

        .recurrente-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .recurrente-icono {
            font-size: 1.5rem;
        }

        .recurrente-detalles h4 {
            font-size: 0.95rem;
            color: var(--color-texto);
            margin-bottom: 3px;
        }

        .recurrente-detalles span {
            font-size: 0.8rem;
            color: var(--color-texto-terciario);
        }

        .recurrente-monto {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .recurrente-monto.ingreso { color: var(--color-exito); }
        .recurrente-monto.gasto { color: var(--color-peligro); }

        .frecuencia-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--color-primario);
            color: white;
        }

        /* === B煤squeda === */
        .busqueda-container {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .busqueda-container input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 2px solid var(--color-borde);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--color-fondo-tarjeta);
            color: var(--color-texto);
        }

        .busqueda-container::before {
            content: "";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
        }

        /* === Importar === */
        .importar-zona {
            border: 2px dashed var(--color-borde);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .importar-zona:hover {
            border-color: var(--color-primario);
            background: var(--color-fondo-secundario);
        }

        .importar-zona.arrastrando {
            border-color: var(--color-primario);
            background: rgba(102, 126, 234, 0.1);
        }

        .importar-zona p {
            color: var(--color-texto-secundario);
            margin-bottom: 10px;
        }

        .importar-input {
            display: none;
        }

        /* === PIN de Seguridad === */
        .pin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradiente-primario);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .pin-overlay.oculto {
            display: none;
        }

        .pin-container {
            background: var(--color-fondo-tarjeta);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            width: 90%;
        }

        .pin-container h2 {
            margin-bottom: 10px;
            color: var(--color-texto);
        }

        .pin-container p {
            color: var(--color-texto-secundario);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .pin-input-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .pin-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid var(--color-borde);
            border-radius: 10px;
            background: var(--color-fondo-secundario);
            color: var(--color-texto);
        }

        .pin-input:focus {
            border-color: var(--color-primario);
            outline: none;
        }

        .pin-error {
            color: var(--color-peligro);
            font-size: 0.85rem;
            margin-bottom: 15px;
            display: none;
        }

        .pin-error.visible {
            display: block;
        }

        /* === Calendario === */
        .calendario-container {
            background: var(--color-fondo-secundario);
            border-radius: 10px;
            padding: 20px;
        }

        .calendario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendario-header h3 {
            color: var(--color-texto);
            font-size: 1.1rem;
        }

        .calendario-nav {
            display: flex;
            gap: 10px;
        }

        .calendario-nav button {
            padding: 8px 15px;
            border: none;
            background: var(--color-primario);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .calendario-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendario-dia-header {
            text-align: center;
            font-weight: 600;
            color: var(--color-texto-secundario);
            padding: 10px 5px;
            font-size: 0.8rem;
        }

        .calendario-dia {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 5px;
            border-radius: 8px;
            background: var(--color-fondo-tarjeta);
            cursor: pointer;
            transition: all 0.2s;
            min-height: 60px;
            position: relative;
        }

        .calendario-dia:hover {
            background: var(--color-borde-claro);
        }

        .calendario-dia.otro-mes {
            opacity: 0.3;
        }

        .calendario-dia.hoy {
            border: 2px solid var(--color-primario);
        }

        .calendario-dia.seleccionado {
            background: var(--color-primario);
            color: white;
        }

        .calendario-dia .numero {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendario-dia .indicadores {
            display: flex;
            gap: 3px;
            margin-top: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .calendario-dia .indicador {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .calendario-dia .indicador.ingreso {
            background: var(--color-exito);
        }

        .calendario-dia .indicador.gasto {
            background: var(--color-peligro);
        }

        .calendario-detalle {
            margin-top: 20px;
            padding: 15px;
            background: var(--color-fondo-tarjeta);
            border-radius: 10px;
            display: none;
        }

        .calendario-detalle.visible {
            display: block;
        }

        .calendario-detalle h4 {
            margin-bottom: 10px;
            color: var(--color-texto);
        }

        .calendario-detalle-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-borde-claro);
        }

        /* === Etiquetas/Tags === */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            background: var(--color-primario);
            color: white;
            border-radius: 15px;
            font-size: 0.75rem;
        }

        .tag .eliminar-tag-mov {
            cursor: pointer;
            font-size: 0.9rem;
        }

        .agregar-tag-input {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .agregar-tag-input input {
            flex: 1;
            padding: 5px 10px;
            border: 1px solid var(--color-borde);
            border-radius: 15px;
            font-size: 0.85rem;
            background: var(--color-fondo-tarjeta);
            color: var(--color-texto);
        }

        /* === Notificaciones === */
        .notificacion-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-fondo-tarjeta);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notificacion-toast.visible {
            transform: translateX(0);
        }

        .notificacion-toast.advertencia {
            border-left: 4px solid var(--color-advertencia);
        }

        .notificacion-toast.exito {
            border-left: 4px solid var(--color-exito);
        }

        .notificacion-toast.error {
            border-left: 4px solid var(--color-peligro);
        }

        .notificacion-toast .cerrar-toast {
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--color-texto-terciario);
        }

        /* === Sincronizaci贸n en la nube === */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--color-fondo-secundario);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .sync-status .sync-icon {
            font-size: 1.2rem;
        }

        .sync-status.sincronizado {
            color: var(--color-exito);
        }

        .sync-status.pendiente {
            color: var(--color-advertencia);
        }

        .sync-status.error {
            color: var(--color-peligro);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .sync-status.sincronizando .sync-icon {
            animation: spin 1s linear infinite;
        }

        /* === Responsive === */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.6rem;
            }

            header p {
                font-size: 0.95rem;
            }

            .container {
                padding: 10px;
            }

            section {
                padding: 15px;
            }

            .tarjeta {
                padding: 20px;
            }

            .tarjeta .monto {
                font-size: 1.5rem;
            }

            .objetivo-container {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }

            .filtros {
                flex-direction: column;
            }

            .filtros .campo {
                width: 100%;
            }

            .agregar-categoria-form {
                flex-direction: column;
            }

            .agregar-categoria-form .campo {
                width: 100%;
            }

            .categoria-item {
                flex-wrap: wrap;
            }

            .categoria-monto {
                width: 100%;
                text-align: left;
                margin-top: 10px;
            }

            .acciones-celda {
                flex-direction: column;
            }
        }

        /* === Animaciones === */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* === Paginaci贸n === */
        .paginacion {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: var(--color-fondo-secundario);
            border-radius: 10px;
        }

        .paginacion-info {
            color: var(--color-texto-secundario);
            font-size: 0.9rem;
        }

        .paginacion-botones {
            display: flex;
            gap: 5px;
        }

        .paginacion-btn {
            padding: 8px 12px;
            border: 1px solid var(--color-borde);
            background: var(--color-fondo-tarjeta);
            color: var(--color-texto);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .paginacion-btn:hover:not(:disabled) {
            background: var(--color-primario);
            color: white;
            border-color: var(--color-primario);
        }

        .paginacion-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .paginacion-btn.activo {
            background: var(--color-primario);
            color: white;
            border-color: var(--color-primario);
        }

        /* === Skeleton Loaders === */
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--color-fondo-secundario) 25%, var(--color-borde-claro) 50%, var(--color-fondo-secundario) 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: 0.5em;
        }

        .skeleton-card {
            height: 100px;
            border-radius: 10px;
        }

        /* === Validaci贸n en tiempo real === */
        .campo input:valid,
        .campo select:valid {
            border-color: var(--color-exito);
        }

        .campo input:invalid:not(:placeholder-shown),
        .campo select:invalid {
            border-color: var(--color-peligro);
        }

        .campo-error {
            color: var(--color-peligro);
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }

        .campo.invalido .campo-error {
            display: block;
        }

        .campo.invalido input,
        .campo.invalido select {
            border-color: var(--color-peligro);
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* === Focus States mejorados (Accesibilidad) === */
        *:focus {
            outline: none;
        }

        *:focus-visible {
            outline: 3px solid var(--color-primario);
            outline-offset: 2px;
        }

        .btn:focus-visible {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.4);
        }

        /* === Skip Link (Accesibilidad) === */
        .skip-link {
            position: absolute;
            top: -100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-primario);
            color: white;
            padding: 10px 20px;
            border-radius: 0 0 10px 10px;
            z-index: 10000;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 0;
        }

        /* === Empty States mejorados === */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-texto-secundario);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--color-texto);
        }

        .empty-state p {
            margin-bottom: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* === Atajos de teclado tooltip === */
        .shortcut-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: var(--color-fondo-secundario);
            border: 1px solid var(--color-borde);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--color-texto-terciario);
            margin-left: 8px;
        }

        .shortcut-badge kbd {
            background: var(--color-fondo-tarjeta);
            padding: 1px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        /* === Ayuda de atajos === */
        .shortcuts-help {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--color-fondo-tarjeta);
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--sombra-tarjeta);
            z-index: 100;
            display: none;
            max-width: 300px;
        }

        .shortcuts-help.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .shortcuts-help h4 {
            margin-bottom: 10px;
            color: var(--color-texto);
        }

        .shortcuts-help ul {
            list-style: none;
            font-size: 0.85rem;
        }

        .shortcuts-help li {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--color-borde-claro);
        }

        .shortcuts-help li:last-child {
            border-bottom: none;
        }

        /* === Bot贸n flotante de ayuda === */
        .btn-ayuda-flotante {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--gradiente-primario);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 99;
            transition: transform 0.2s;
        }

        .btn-ayuda-flotante:hover {
            transform: scale(1.1);
        }

        /* === Indicador de carga === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        [data-tema="oscuro"] .loading-overlay {
            background: rgba(26, 26, 46, 0.9);
        }

        .loading-overlay.visible {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--color-borde);
            border-top-color: var(--color-primario);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* === Micro-animaciones === */
        .tarjeta {
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }

        .btn {
            transition: all 0.2s ease;
        }

        .btn:active {
            transform: scale(0.98);
        }

        tbody tr {
            transition: background 0.2s ease, transform 0.2s ease;
        }

        tbody tr:hover {
            transform: translateX(5px);
        }

        /* === Responsive mejorado para m贸vil === */
        @media (max-width: 768px) {
            .shortcuts-help,
            .btn-ayuda-flotante,
            .shortcut-badge {
                display: none !important;
            }

            .paginacion {
                flex-direction: column;
                gap: 15px;
            }

            .resumen {
                grid-template-columns: repeat(2, 1fr);
            }

            .tarjeta .monto {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) {
            .resumen {
                grid-template-columns: 1fr;
            }
        }

        /* === Sistema de Navegaci贸n por Tabs === */
        .tabs-navegacion {
            display: flex;
            gap: 5px;
            background: var(--color-fondo-tarjeta);
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--sombra-tarjeta);
            position: sticky;
            top: 10px;
            z-index: 100;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--color-texto-secundario);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: var(--color-fondo-secundario);
            color: var(--color-texto);
        }

        .tab-btn.activo {
            background: var(--gradiente-primario);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-btn .tab-icono {
            font-size: 1.1rem;
        }

        .tab-contenido {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-contenido.activo {
            display: block;
        }

        /* === Bot贸n Flotante de Acci贸n === */
        .btn-accion-flotante {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradiente-primario);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.8rem;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-accion-flotante:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-accion-flotante:active {
            transform: scale(0.95);
        }

        /* === Dashboard Compacto === */
        .dashboard-compacto {
            margin-bottom: 20px;
        }

        .dashboard-compacto .resumen {
            margin-bottom: 0;
        }

        .dashboard-compacto .tarjeta {
            padding: 15px;
        }

        .dashboard-compacto .tarjeta .icono {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .dashboard-compacto .tarjeta h3 {
            font-size: 0.75rem;
        }

        .dashboard-compacto .tarjeta .monto {
            font-size: 1.4rem;
        }

        .dashboard-compacto .tarjeta .subtexto {
            font-size: 0.7rem;
        }

        /* === Secciones dentro de tabs === */
        .tab-seccion {
            background: var(--color-fondo-tarjeta);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--sombra-tarjeta);
            border: var(--borde-tarjeta);
        }

        .tab-seccion h2 {
            font-size: 1.2rem;
            color: var(--color-texto);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-borde-claro);
        }

        /* === Modal de Acci贸n R谩pida === */
        .modal-accion-rapida {
            position: fixed;
            bottom: 100px;
            right: 25px;
            background: var(--color-fondo-tarjeta);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 999;
            width: 320px;
            max-width: calc(100vw - 50px);
            display: none;
            animation: slideUp 0.3s ease;
        }

        .modal-accion-rapida.visible {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-accion-rapida h3 {
            margin-bottom: 15px;
            font-size: 1rem;
            color: var(--color-texto);
        }

        .modal-accion-rapida .campo {
            margin-bottom: 12px;
        }

        .modal-accion-rapida .campo label {
            font-size: 0.8rem;
        }

        .modal-accion-rapida .campo input,
        .modal-accion-rapida .campo select {
            padding: 10px;
            font-size: 0.9rem;
        }

        .modal-accion-rapida .btn-grupo {
            margin-top: 15px;
        }

        /* === Responsive para Tabs === */
        @media (max-width: 768px) {
            .tabs-navegacion {
                padding: 8px;
                gap: 3px;
                border-radius: 12px;
            }

            .tab-btn {
                padding: 10px 12px;
                font-size: 0.8rem;
                min-width: auto;
                flex-direction: column;
                gap: 4px;
            }

            .tab-btn .tab-texto {
                display: none;
            }

            .tab-btn .tab-icono {
                font-size: 1.3rem;
            }

            .btn-accion-flotante {
                bottom: 20px;
                right: 20px;
                width: 55px;
                height: 55px;
                font-size: 1.5rem;
            }

            .modal-accion-rapida {
                right: 10px;
                left: 10px;
                width: auto;
                bottom: 90px;
            }

            .dashboard-compacto .resumen {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .dashboard-compacto .tarjeta {
                padding: 10px;
            }

            .dashboard-compacto .tarjeta .icono {
                font-size: 1.2rem;
            }

            .dashboard-compacto .tarjeta h3 {
                font-size: 0.65rem;
            }

            .dashboard-compacto .tarjeta .monto {
                font-size: 1rem;
            }

            .dashboard-compacto .tarjeta .subtexto {
                display: none;
            }

            .tab-seccion {
                padding: 15px;
                border-radius: 12px;
            }

            .tab-seccion h2 {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .dashboard-compacto .resumen {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-compacto .tarjeta:last-child {
                grid-column: span 2;
            }
        }
    </style>
</head>
<body>

    <!-- ==================== PIN DE SEGURIDAD ==================== -->
    <div class="pin-overlay" id="pin-overlay">
        <div class="pin-container">
            <h2> Acceso Seguro</h2>
            <p id="pin-mensaje">Ingresa tu PIN de 4 d铆gitos</p>
            <div class="pin-input-container">
                <input type="password" class="pin-input" maxlength="1" id="pin-1" oninput="moverPinInput(1)" onkeydown="manejarBackspacePin(event, 1)">
                <input type="password" class="pin-input" maxlength="1" id="pin-2" oninput="moverPinInput(2)" onkeydown="manejarBackspacePin(event, 2)">
                <input type="password" class="pin-input" maxlength="1" id="pin-3" oninput="moverPinInput(3)" onkeydown="manejarBackspacePin(event, 3)">
                <input type="password" class="pin-input" maxlength="1" id="pin-4" oninput="moverPinInput(4)" onkeydown="manejarBackspacePin(event, 4)">
            </div>
            <p class="pin-error" id="pin-error">PIN incorrecto. Intenta de nuevo.</p>
            <button class="btn btn-primario" onclick="verificarPin()" id="btn-pin">Ingresar</button>
            <p style="margin-top: 15px; font-size: 0.8rem; color: var(--color-texto-terciario);">
                <a href="#" onclick="mostrarConfigPin()" style="color: var(--color-primario);">Configurar/Cambiar PIN</a>
            </p>
        </div>
    </div>

    <!-- ==================== NOTIFICACIN TOAST ==================== -->
    <div class="notificacion-toast" id="notificacion-toast">
        <span class="toast-icono">锔</span>
        <div class="toast-contenido">
            <strong id="toast-titulo">T铆tulo</strong>
            <p id="toast-mensaje" style="margin: 0; font-size: 0.85rem;">Mensaje</p>
        </div>
        <span class="cerrar-toast" onclick="cerrarToast()"></span>
    </div>

    <!-- ==================== ENCABEZADO ==================== -->
    <header>
        <!-- Selector de tema -->
        <div class="tema-selector">
            <button class="tema-btn activo" data-tema-valor="claro" onclick="cambiarTema('claro')" title="Tema Claro">锔</button>
            <button class="tema-btn" data-tema-valor="oscuro" onclick="cambiarTema('oscuro')" title="Tema Oscuro"></button>
            <button class="tema-btn" data-tema-valor="naturaleza" onclick="cambiarTema('naturaleza')" title="Tema Naturaleza"></button>
            <button class="tema-btn" data-tema-valor="oceano" onclick="cambiarTema('oceano')" title="Tema Oc茅ano"></button>
        </div>
        <h1> Panel de Finanzas Personales</h1>
        <p>Organiza tus ingresos, gastos y ahorros en un solo lugar</p>
    </header>

    <div class="container">
        
        <!-- ==================== SECCIN DE RESUMEN ==================== -->
        <div class="resumen">
            <!-- Tarjeta de ingresos totales -->
            <div class="tarjeta ingresos">
                <div class="icono"></div>
                <h3>Ingresos del Mes</h3>
                <div class="monto" id="total-ingresos">$0</div>
                <div class="subtexto" id="count-ingresos">0 transacciones</div>
            </div>
            
            <!-- Tarjeta de gastos totales -->
            <div class="tarjeta gastos">
                <div class="icono"></div>
                <h3>Gastos del Mes</h3>
                <div class="monto" id="total-gastos">$0</div>
                <div class="subtexto" id="count-gastos">0 transacciones</div>
            </div>
            
            <!-- Tarjeta de balance -->
            <div class="tarjeta balance">
                <div class="icono">锔</div>
                <h3>Balance del Mes</h3>
                <div class="monto" id="balance">$0</div>
                <div class="subtexto" id="balance-estado">Neutro</div>
            </div>
            
            <!-- Tarjeta de ahorro -->
            <div class="tarjeta ahorro">
                <div class="icono"></div>
                <h3>Objetivo de Ahorro</h3>
                <div class="monto" id="ahorro-porcentaje">0%</div>
                <div class="subtexto" id="ahorro-estado">Sin objetivo</div>
            </div>

            <!-- Tarjeta de transacciones totales -->
            <div class="tarjeta transacciones">
                <div class="icono"></div>
                <h3>Total Hist贸rico</h3>
                <div class="monto" id="total-transacciones">0</div>
                <div class="subtexto">movimientos registrados</div>
            </div>
        </div>

        <!-- ==================== NAVEGACIN POR TABS ==================== -->
        <nav class="tabs-navegacion" role="tablist" aria-label="Secciones principales">
            <button class="tab-btn activo" onclick="cambiarTab('movimientos')" role="tab" aria-selected="true" aria-controls="tab-movimientos" id="tab-btn-movimientos">
                <span class="tab-icono"></span>
                <span class="tab-texto">Movimientos</span>
            </button>
            <button class="tab-btn" onclick="cambiarTab('estadisticas')" role="tab" aria-selected="false" aria-controls="tab-estadisticas" id="tab-btn-estadisticas">
                <span class="tab-icono"></span>
                <span class="tab-texto">Estad铆sticas</span>
            </button>
            <button class="tab-btn" onclick="cambiarTab('configuracion')" role="tab" aria-selected="false" aria-controls="tab-configuracion" id="tab-btn-configuracion">
                <span class="tab-icono">锔</span>
                <span class="tab-texto">Configuraci贸n</span>
            </button>
        </nav>

        <!-- ==================== TAB: MOVIMIENTOS ==================== -->
        <div class="tab-contenido activo" id="tab-movimientos" role="tabpanel" aria-labelledby="tab-btn-movimientos">

            <!-- Secci贸n de Registro de Movimientos -->
            <section class="tab-seccion">
                <h2> Registrar Nuevo Movimiento</h2>
                
                <!-- Mensaje de estado para feedback al usuario -->
                <div class="mensaje" id="mensaje"></div>
                
                <!-- Formulario para agregar transacciones -->
                <form id="formulario-movimiento" onsubmit="agregarMovimiento(event)">
                    <div class="formulario-grid">
                        <!-- Campo de tipo de transacci贸n -->
                        <div class="campo">
                            <label for="tipo">Tipo *</label>
                            <select id="tipo" required>
                                <option value="">Seleccionar...</option>
                                <option value="Ingreso">Ingreso</option>
                                <option value="Gasto">Gasto</option>
                                <option value="Ahorro">Ahorro </option>
                            </select>
                        </div>
                        
                        <!-- Campo de categor铆a -->
                        <div class="campo">
                            <label for="categoria">Categor铆a *</label>
                            <select id="categoria" required>
                                <option value="">Seleccionar...</option>
                                <!-- Las categor铆as se cargan din谩micamente -->
                            </select>
                        </div>
                        
                        <!-- Campo de monto -->
                        <div class="campo">
                            <label for="monto">Monto ($) *</label>
                            <input type="number" id="monto" placeholder="Ej: 50000" min="0.01" step="0.01" required>
                        </div>
                        
                        <!-- Campo de fecha -->
                        <div class="campo">
                            <label for="fecha">Fecha *</label>
                            <input type="date" id="fecha" required>
                        </div>
                        
                        <!-- Campo de descripci贸n opcional -->
                        <div class="campo" style="grid-column: 1 / -1;">
                            <label for="descripcion">Descripci贸n (opcional)</label>
                            <textarea id="descripcion" placeholder="Ej: Pago de n贸mina quincenal..."></textarea>
                        </div>

                        <!-- Campo de etiquetas -->
                        <div class="campo" style="grid-column: 1 / -1;">
                            <label for="etiquetas">Etiquetas (separadas por coma)</label>
                            <input type="text" id="etiquetas" placeholder="Ej: trabajo, mensual, importante">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primario">Agregar Movimiento</button>
                </form>
            </section>

            <!-- Secci贸n de Historial de Movimientos -->
            <section class="tab-seccion">
                <h2> Historial de Movimientos</h2>
                
                <!-- Herramientas de exportaci贸n -->
                <div class="herramientas">
                    <button class="btn btn-secundario btn-pequeno" onclick="exportarCSV()"> Exportar CSV</button>
                    <button class="btn btn-secundario btn-pequeno" onclick="exportarJSON()"> Exportar JSON</button>
                    <button class="btn btn-eliminar btn-pequeno" onclick="limpiarTodosDatos()">锔 Limpiar Todo</button>
                </div>
                
                <!-- Filtros para la tabla -->
                <div class="filtros">
                    <div class="busqueda-container">
                        <input type="text" id="filtro-busqueda" placeholder="Buscar en descripci贸n..." oninput="aplicarFiltrosConDebounce()" aria-label="Buscar movimientos">
                    </div>
                    <div class="campo">
                        <label for="filtro-tipo">Filtrar por tipo</label>
                        <select id="filtro-tipo" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="Ingreso">Ingresos</option>
                            <option value="Gasto">Gastos</option>
                            <option value="Ahorro">Ahorros</option>
                        </select>
                    </div>
                    <div class="campo">
                        <label for="filtro-categoria">Filtrar por categor铆a</label>
                        <select id="filtro-categoria" onchange="aplicarFiltros()">
                            <option value="">Todas</option>
                            <!-- Las opciones se llenar谩n din谩micamente -->
                        </select>
                    </div>
                    <div class="campo">
                        <label for="filtro-fecha-desde">Desde</label>
                        <input type="date" id="filtro-fecha-desde" onchange="aplicarFiltros()">
                    </div>
                    <div class="campo">
                        <label for="filtro-fecha-hasta">Hasta</label>
                        <input type="date" id="filtro-fecha-hasta" onchange="aplicarFiltros()">
                    </div>
                    <button class="btn btn-secundario" onclick="limpiarFiltros()">Limpiar filtros</button>
                </div>
                
                <!-- Tabla de movimientos -->
                <div class="tabla-container" role="region" aria-label="Historial de movimientos">
                    <table id="tabla-movimientos" role="table" aria-describedby="tabla-descripcion">
                        <caption id="tabla-descripcion" class="sr-only">Lista de movimientos financieros con fecha, tipo, categor铆a, descripci贸n y monto</caption>
                        <thead>
                            <tr role="row">
                                <th onclick="ordenarTabla('fecha')">
                                    Fecha <span class="flecha" id="flecha-fecha"></span>
                                </th>
                                <th onclick="ordenarTabla('tipo')">
                                    Tipo <span class="flecha" id="flecha-tipo"></span>
                                </th>
                                <th onclick="ordenarTabla('categoria')">
                                    Categor铆a <span class="flecha" id="flecha-categoria"></span>
                                </th>
                                <th>Descripci贸n</th>
                                <th onclick="ordenarTabla('monto')">
                                    Monto <span class="flecha" id="flecha-monto"></span>
                                </th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpo-tabla">
                            <!-- Los movimientos se renderizar谩n aqu铆 din谩micamente -->
                        </tbody>
                    </table>
                    
                    <!-- Mensaje cuando no hay datos -->
                    <div class="sin-datos empty-state" id="sin-datos">
                        <div class="empty-state-icon"></div>
                        <h3>No hay movimientos registrados</h3>
                        <p>隆Comienza agregando tu primer ingreso, gasto o ahorro para llevar el control de tus finanzas!</p>
                        <button class="btn btn-primario" onclick="document.getElementById('tipo').focus();">
                             Agregar primer movimiento
                        </button>
                    </div>
                </div>
            </section>

            <!-- Secci贸n de Calendario -->
            <section class="tab-seccion">
                <h2> Calendario de Movimientos</h2>
                <div class="calendario-container">
                    <div class="calendario-header">
                        <h3 id="calendario-titulo">Diciembre 2025</h3>
                        <div class="calendario-nav">
                            <button onclick="navegarCalendario(-1)"></button>
                            <button onclick="navegarCalendario(0)">Hoy</button>
                            <button onclick="navegarCalendario(1)"></button>
                        </div>
                    </div>
                    <div class="calendario-grid" id="calendario-grid">
                        <!-- Se llena din谩micamente -->
                    </div>
                    <div class="calendario-detalle" id="calendario-detalle">
                        <h4 id="calendario-detalle-fecha">Movimientos del d铆a</h4>
                        <div id="calendario-detalle-lista"></div>
                    </div>
                </div>
            </section>

        </div>

        <!-- ==================== TAB: ESTADSTICAS ==================== -->
        <div class="tab-contenido" id="tab-estadisticas" role="tabpanel" aria-labelledby="tab-btn-estadisticas">

            <!-- Secci贸n de Resumen por Categor铆as -->
            <section class="tab-seccion">
                <h2> Resumen por Categor铆as (Este Mes)</h2>
                <div class="categorias-grid" id="resumen-categorias">
                    <!-- Se llena din谩micamente -->
                </div>
                <div class="sin-datos" id="sin-categorias" style="display: none;">
                    Agrega movimientos para ver el resumen por categor铆as.
                </div>
            </section>

            <!-- Secci贸n de Gr谩ficos -->
            <section class="tab-seccion">
                <h2> Gr谩ficos y Estad铆sticas</h2>
                
                <!-- Selector de per铆odo -->
                <div class="periodo-selector">
                    <label for="grafico-mes">Mes:</label>
                    <select id="grafico-mes" onchange="actualizarGraficos()">
                        <!-- Se llena din谩micamente -->
                    </select>
                    <label for="grafico-anio">A帽o:</label>
                    <select id="grafico-anio" onchange="actualizarGraficos()">
                        <!-- Se llena din谩micamente -->
                    </select>
                </div>
                
                <div class="graficos-container">
                    <div class="grafico-wrapper">
                        <h4>Distribuci贸n de Gastos</h4>
                        <canvas id="grafico-gastos" class="grafico-canvas"></canvas>
                    </div>
                    <div class="grafico-wrapper">
                        <h4>Ingresos vs Gastos</h4>
                        <canvas id="grafico-balance" class="grafico-canvas"></canvas>
                    </div>
                    <div class="grafico-wrapper">
                        <h4>Tendencia Mensual</h4>
                        <canvas id="grafico-tendencia" class="grafico-canvas"></canvas>
                    </div>
                    <div class="grafico-wrapper">
                        <h4>Distribuci贸n de Ingresos</h4>
                        <canvas id="grafico-ingresos" class="grafico-canvas"></canvas>
                    </div>
                </div>
            </section>

            <!-- Secci贸n de Control de Gastos -->
            <section class="tab-seccion">
                <h2> Control de Gastos por Categor铆a</h2>
                <p style="color: var(--color-texto-secundario); margin-bottom: 15px;">
                     Comparaci贸n autom谩tica de tus gastos actuales vs. el promedio de los 煤ltimos 3 meses.
                </p>
                
                <div class="presupuestos-grid" id="presupuestos-lista">
                    <!-- Se llena din谩micamente -->
                </div>
                <div class="sin-datos" id="sin-presupuestos" style="display: none;">
                    A煤n no tienes gastos registrados. 隆Comienza a registrar para ver el an谩lisis!
                </div>
            </section>

        </div>

        <!-- ==================== TAB: CONFIGURACIN ==================== -->
        <div class="tab-contenido" id="tab-configuracion" role="tabpanel" aria-labelledby="tab-btn-configuracion">

            <!-- Secci贸n de Objetivo de Ahorro -->
            <section class="tab-seccion">
            <h2> Objetivo de Ahorro Mensual</h2>
            <div class="objetivo-container">
                <div class="objetivo-input">
                    <div class="campo">
                        <label for="objetivo-monto">Meta de ahorro ($)</label>
                        <input type="number" id="objetivo-monto" placeholder="Ej: 500000" min="0">
                    </div>
                    <button class="btn btn-primario" onclick="guardarObjetivo()">Establecer Objetivo</button>
                </div>
                <div class="progreso-container">
                    <div class="progreso-info">
                        <span>Ahorrado: <strong id="monto-ahorrado">$0</strong></span>
                        <span>Meta: <strong id="meta-ahorro">$0</strong></span>
                    </div>
                    <div class="progreso-barra">
                        <div class="progreso-relleno" id="progreso-relleno" style="width: 0%"></div>
                    </div>
                    <div class="progreso-porcentaje" id="progreso-porcentaje">0%</div>
                </div>
            </div>
        </section>

            <!-- Secci贸n de Gesti贸n de Categor铆as -->
            <section class="tab-seccion">
                <h2>凤 Gestionar Categor铆as</h2>
                <p style="color: var(--color-texto-secundario); margin-bottom: 15px;">Agrega tus propias categor铆as personalizadas para organizar mejor tus finanzas.</p>
                
                <div class="categorias-personalizadas">
                    <h4> Categor铆as de Ingreso</h4>
                    <div class="lista-categorias" id="lista-categorias-ingreso">
                        <!-- Se llenan din谩micamente -->
                    </div>
                    
                    <h4 style="margin-top: 20px;"> Categor铆as de Gasto</h4>
                    <div class="lista-categorias" id="lista-categorias-gasto">
                        <!-- Se llenan din谩micamente -->
                    </div>
                    
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--color-borde);">
                    
                    <h4> Agregar Nueva Categor铆a</h4>
                    <div class="agregar-categoria-form">
                        <div class="campo">
                            <label for="nueva-categoria-tipo">Tipo</label>
                            <select id="nueva-categoria-tipo">
                                <option value="Ingreso">Ingreso</option>
                                <option value="Gasto">Gasto</option>
                            </select>
                        </div>
                        <div class="campo">
                            <label for="nueva-categoria-nombre">Nombre de la categor铆a</label>
                            <input type="text" id="nueva-categoria-nombre" placeholder="Ej: Bonificaciones">
                        </div>
                        <div class="campo">
                            <label for="nueva-categoria-icono">Icono (emoji)</label>
                            <input type="text" id="nueva-categoria-icono" placeholder="Ej: " maxlength="2">
                        </div>
                        <button class="btn btn-exito" onclick="agregarCategoriaPersonalizada()">Agregar</button>
                    </div>
                </div>
            </section>

            <!-- Secci贸n de Movimientos Recurrentes -->
            <section class="tab-seccion">
                <h2> Movimientos Recurrentes</h2>
                <p style="color: var(--color-texto-secundario); margin-bottom: 15px;">
                    Configura ingresos o gastos que se repiten autom谩ticamente (salario, suscripciones, arriendo).
                </p>
                
                <div class="recurrentes-lista" id="recurrentes-lista">
                    <!-- Se llena din谩micamente -->
                </div>
                <div class="sin-datos" id="sin-recurrentes" style="display: none;">
                    No hay movimientos recurrentes configurados.
                </div>
                
                <div class="agregar-categoria-form" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--color-borde);">
                    <div class="campo">
                        <label for="recurrente-tipo">Tipo</label>
                        <select id="recurrente-tipo" onchange="actualizarCategoriasRecurrente()">
                            <option value="Ingreso">Ingreso</option>
                            <option value="Gasto">Gasto</option>
                            <option value="Ahorro">Ahorro</option>
                        </select>
                    </div>
                    <div class="campo">
                        <label for="recurrente-categoria">Categor铆a</label>
                        <select id="recurrente-categoria">
                            <!-- Se llena din谩micamente -->
                        </select>
                    </div>
                    <div class="campo">
                        <label for="recurrente-descripcion">Descripci贸n</label>
                        <input type="text" id="recurrente-descripcion" placeholder="Ej: Salario mensual">
                    </div>
                    <div class="campo">
                        <label for="recurrente-monto">Monto ($)</label>
                        <input type="number" id="recurrente-monto" placeholder="Ej: 3000000" min="0">
                    </div>
                    <div class="campo">
                        <label for="recurrente-frecuencia">Frecuencia</label>
                        <select id="recurrente-frecuencia">
                            <option value="semanal">Semanal</option>
                            <option value="quincenal">Quincenal</option>
                            <option value="mensual" selected>Mensual</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                    <div class="campo">
                        <label for="recurrente-dia">D铆a del mes</label>
                        <input type="number" id="recurrente-dia" placeholder="1-31" min="1" max="31" value="1">
                    </div>
                    <button class="btn btn-exito" onclick="agregarRecurrente()">Agregar Recurrente</button>
                </div>
            </section>

            <!-- Secci贸n de Importar/Exportar -->
            <section class="tab-seccion">
                <h2> Almacenamiento y Respaldo de Datos</h2>
                
                <!-- Opciones de exportaci贸n b谩sica -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;"> Exportar Datos</h4>
                    <div class="herramientas">
                        <button class="btn btn-secundario" onclick="exportarCSV()"> Exportar CSV</button>
                        <button class="btn btn-secundario" onclick="exportarJSON()"> Exportar JSON</button>
                        <button class="btn btn-secundario" onclick="generarReportePDF()"> Reporte PDF</button>
                    </div>
                </div>
                
                <!-- Importar archivo -->
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--color-borde);">
                    <h4 style="margin-bottom: 10px;"> Importar Datos</h4>
                    <div class="importar-zona" id="zona-importar" onclick="document.getElementById('archivo-importar').click()">
                        <p> Arrastra un archivo aqu铆 o haz clic para importar</p>
                        <p style="font-size: 0.85rem;">Soporta archivos .json (backup completo) o .csv (movimientos)</p>
                        <input type="file" id="archivo-importar" class="importar-input" accept=".json,.csv" onchange="importarArchivo(event)">
                    </div>
                </div>

                <!-- File System API - Archivo Local Persistente -->
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--color-borde);">
                    <h4 style="margin-bottom: 10px;"> Archivo Local Persistente</h4>
                    <p style="color: var(--color-texto-secundario); font-size: 0.9rem; margin-bottom: 15px;">
                        Guarda tus datos en un archivo en tu computadora. Sobrevive a limpieza de cach茅. 
                        <strong>Solo Chrome/Edge</strong>.
                    </p>
                    <div class="btn-grupo">
                        <button class="btn btn-primario" onclick="guardarArchivoLocal()"> Guardar en Archivo</button>
                        <button class="btn btn-secundario" onclick="cargarArchivoLocal()"> Cargar desde Archivo</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="auto-guardar-archivo" onchange="toggleAutoGuardadoArchivo()">
                            Auto-guardar cada vez que haya cambios
                        </label>
                    </div>
                    <div class="sync-status" id="archivo-status" style="margin-top: 10px;">
                        <span></span>
                        <span id="archivo-texto">Sin archivo vinculado</span>
                    </div>
                </div>

                <!-- GitHub Gist - Sincronizaci贸n en la Nube -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">锔 Sincronizaci贸n con GitHub Gist</h4>
                    <p style="color: var(--color-texto-secundario); font-size: 0.9rem; margin-bottom: 15px;">
                        Guarda tus datos en la nube de forma gratuita. Accede desde cualquier dispositivo.
                    </p>
                    
                    <!-- Configuraci贸n de GitHub -->
                    <div id="github-config" style="background: var(--color-fondo-secundario); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div class="campo" style="margin-bottom: 10px;">
                            <label for="github-token">Token de GitHub (Personal Access Token)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx" style="flex: 1;">
                                <button class="btn btn-secundario btn-pequeno" onclick="toggleVerToken()">锔</button>
                            </div>
                            <small style="color: var(--color-texto-terciario);">
                                <a href="#" onclick="mostrarAyudaGitHub()" style="color: var(--color-primario);">驴C贸mo obtener un token?</a>
                            </small>
                        </div>
                        <div class="campo" style="margin-bottom: 10px;">
                            <label for="gist-id">ID del Gist (opcional, para sincronizar con uno existente)</label>
                            <input type="text" id="gist-id" placeholder="Dejar vac铆o para crear uno nuevo">
                        </div>
                        <button class="btn btn-exito btn-pequeno" onclick="guardarConfigGitHub()"> Guardar Configuraci贸n</button>
                    </div>
                    
                    <div class="btn-grupo">
                        <button class="btn btn-primario" onclick="sincronizarGitHub()">锔 Sincronizar con GitHub</button>
                        <button class="btn btn-secundario" onclick="cargarDesdeGitHub()"> Descargar de GitHub</button>
                    </div>
                    
                    <div class="sync-status" id="github-status" style="margin-top: 10px;">
                        <span class="sync-icon">锔</span>
                        <span id="github-texto">No configurado</span>
                    </div>
                </div>

            </section>

        </div>
        <!-- Fin de TAB: CONFIGURACIN -->

    </div>
    <!-- Fin de .container -->

    <!-- ==================== BOTN FLOTANTE DE ACCIN RPIDA ==================== -->
    <button class="btn-accion-flotante" onclick="toggleModalAccionRapida()" aria-label="Agregar movimiento r谩pido" title="Agregar movimiento">
        +
    </button>

    <!-- ==================== MODAL DE ACCIN RPIDA ==================== -->
    <div class="modal-accion-rapida" id="modal-accion-rapida">
        <h3> Agregar Movimiento R谩pido</h3>
        <div class="campo">
            <label for="rapido-tipo">Tipo</label>
            <select id="rapido-tipo" onchange="actualizarCategoriasRapido()">
                <option value="Gasto">Gasto</option>
                <option value="Ingreso">Ingreso</option>
                <option value="Ahorro">Ahorro</option>
            </select>
        </div>
        <div class="campo">
            <label for="rapido-categoria">Categor铆a</label>
            <select id="rapido-categoria">
                <!-- Se llena din谩micamente -->
            </select>
        </div>
        <div class="campo">
            <label for="rapido-monto">Monto ($)</label>
            <input type="number" id="rapido-monto" placeholder="Ej: 50000" min="0.01" step="0.01">
        </div>
        <div class="campo">
            <label for="rapido-descripcion">Descripci贸n</label>
            <input type="text" id="rapido-descripcion" placeholder="Ej: Almuerzo">
        </div>
        <div class="btn-grupo">
            <button class="btn btn-secundario btn-pequeno" onclick="toggleModalAccionRapida()">Cancelar</button>
            <button class="btn btn-primario btn-pequeno" onclick="agregarMovimientoRapido()">Agregar</button>
        </div>
    </div>

    <!-- ==================== MODAL DE EDICIN ==================== -->
    <div class="modal-overlay" id="modal-editar">
        <div class="modal">
            <h3>锔 Editar Movimiento</h3>
            <input type="hidden" id="editar-id">
            <div class="formulario-grid">
                <div class="campo">
                    <label for="editar-tipo">Tipo</label>
                    <select id="editar-tipo" onchange="actualizarCategoriasEditar()">
                        <option value="Ingreso">Ingreso</option>
                        <option value="Gasto">Gasto</option>
                        <option value="Ahorro">Ahorro</option>
                    </select>
                </div>
                <div class="campo">
                    <label for="editar-categoria">Categor铆a</label>
                    <select id="editar-categoria"></select>
                </div>
                <div class="campo">
                    <label for="editar-monto">Monto ($)</label>
                    <input type="number" id="editar-monto" min="0.01" step="0.01">
                </div>
                <div class="campo">
                    <label for="editar-fecha">Fecha</label>
                    <input type="date" id="editar-fecha">
                </div>
                <div class="campo" style="grid-column: 1 / -1;">
                    <label for="editar-descripcion">Descripci贸n</label>
                    <textarea id="editar-descripcion"></textarea>
                </div>
                <div class="campo" style="grid-column: 1 / -1;">
                    <label for="editar-etiquetas">Etiquetas (separadas por coma)</label>
                    <input type="text" id="editar-etiquetas" placeholder="Ej: trabajo, mensual">
                </div>
            </div>
            <div class="modal-botones">
                <button class="btn btn-secundario" onclick="cerrarModalEditar()">Cancelar</button>
                <button class="btn btn-primario" onclick="guardarEdicion()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // ==================== VARIABLES GLOBALES ====================
        
        // Array para almacenar todos los movimientos
        let movimientos = [];
        
        // Objetivo de ahorro mensual
        let objetivoAhorro = 0;
        
        // Configuraci贸n de ordenamiento actual
        let ordenActual = { campo: 'fecha', direccion: 'desc' };

        // Tema actual de la aplicaci贸n
        let temaActual = 'claro';

        // Categor铆as predefinidas con iconos
        const categoriasPredefinidas = {
            Ingreso: [
                { nombre: 'Salario', icono: '' },
                { nombre: 'Freelance', icono: '' },
                { nombre: 'Inversiones', icono: '' },
                { nombre: 'Bonificaciones', icono: '' },
                { nombre: 'Ventas', icono: '' },
                { nombre: 'Alquiler', icono: '' },
                { nombre: 'Reembolsos', icono: '╋' },
                { nombre: 'Pr茅stamos recibidos', icono: '' },
                { nombre: 'Otros ingresos', icono: '' }
            ],
            Ahorro: [
                { nombre: 'Fondo de emergencia', icono: '★' },
                { nombre: 'Meta espec铆fica', icono: '' },
                { nombre: 'Inversi贸n', icono: '' },
                { nombre: 'Retiro/Pensi贸n', icono: '' },
                { nombre: 'Educaci贸n', icono: '' },
                { nombre: 'Viaje', icono: '锔' },
                { nombre: 'Vivienda', icono: '' },
                { nombre: 'Veh铆culo', icono: '' },
                { nombre: 'Tecnolog铆a', icono: '' },
                { nombre: 'Otro ahorro', icono: '' }
            ],
            Gasto: [
                { nombre: 'Comida', icono: '' },
                { nombre: 'Supermercado', icono: '' },
                { nombre: 'Transporte', icono: '' },
                { nombre: 'Combustible', icono: '' },
                { nombre: 'Servicios', icono: '' },
                { nombre: 'Internet/Tel茅fono', icono: '' },
                { nombre: 'Alquiler/Hipoteca', icono: '' },
                { nombre: 'Ocio', icono: '' },
                { nombre: 'Restaurantes', icono: '斤' },
                { nombre: 'Salud', icono: '' },
                { nombre: 'Farmacia', icono: '' },
                { nombre: 'Educaci贸n', icono: '' },
                { nombre: 'Ropa', icono: '' },
                { nombre: 'Hogar', icono: '' },
                { nombre: 'Mascotas', icono: '' },
                { nombre: 'Suscripciones', icono: '' },
                { nombre: 'Gimnasio', icono: '锔' },
                { nombre: 'Deudas', icono: '' },
                { nombre: 'Regalos', icono: '' },
                { nombre: 'Viajes', icono: '锔' },
                { nombre: 'Impuestos', icono: '' },
                { nombre: 'Seguros', icono: '★' },
                { nombre: 'Otros gastos', icono: '' }
            ]
        };

        // Categor铆as personalizadas del usuario
        let categoriasPersonalizadas = {
            Ingreso: [],
            Gasto: [],
            Ahorro: []
        };

        // Presupuestos por categor铆a
        let presupuestos = {};

        // Movimientos recurrentes
        let movimientosRecurrentes = [];

        // Instancias de gr谩ficos Chart.js
        let graficos = {};

        // PIN de seguridad
        let pinSeguridad = null;
        let pinConfigurado = false;

        // Calendario
        let calendarioMes = new Date().getMonth();
        let calendarioAnio = new Date().getFullYear();
        let calendarioDiaSeleccionado = null;

        // Sincronizaci贸n
        let ultimaSincronizacion = null;

        // Paginaci贸n
        let paginaActual = 1;
        const itemsPorPagina = 15;

        // Debounce timer
        let debounceTimer = null;
        
        // ==================== INICIALIZACIN ====================
        
        /**
         * Funci贸n que se ejecuta al cargar la p谩gina.
         * Carga los datos guardados en localStorage y configura la fecha actual.
         */
        function inicializar() {
            // Cargar datos desde localStorage si existen
            cargarDatosLocalStorage();
            
            // Cargar tema guardado
            cargarTema();
            
            // Establecer la fecha actual como valor por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = hoy;
            
            // Configurar el evento de cambio de tipo para actualizar categor铆as
            document.getElementById('tipo').addEventListener('change', actualizarCategoriasFormulario);
            
            // Actualizar todas las secciones de la interfaz
            actualizarCategoriasFormulario();
            renderizarCategoriasPersonalizadas();
            actualizarResumen();
            actualizarTabla();
            actualizarObjetivoAhorro();
            actualizarFiltroCategorias();
            actualizarResumenCategorias();
            
            // Inicializar nuevas funcionalidades
            inicializarGraficos();
            actualizarPresupuestos();
            actualizarRecurrentes();
            actualizarCategoriasRecurrente();
            cargarCategoriasPresupuesto();
            verificarRecurrentesPendientes();
            configurarImportacion();
            
            // Nuevas funcionalidades v2.0
            verificarPinSeguridad();
            inicializarCalendario();
            verificarYEjecutarRecurrentes();
            verificarPresupuestosExcedidos();
            
            // Sistema de tabs
            restaurarTabActivo();
            actualizarCategoriasRapido();
            
            // Cargar configuraci贸n de GitHub si existe
            cargarConfigGitHub();
        }
        
        // ==================== FUNCIONES DE TEMA ====================

        /**
         * Cambia el tema de la aplicaci贸n.
         * @param {string} tema - Nombre del tema ('claro', 'oscuro', 'naturaleza', 'oceano')
         */
        function cambiarTema(tema) {
            temaActual = tema;
            
            // Aplicar tema al documento
            if (tema === 'claro') {
                document.documentElement.removeAttribute('data-tema');
            } else {
                document.documentElement.setAttribute('data-tema', tema);
            }
            
            // Actualizar botones activos
            document.querySelectorAll('.tema-btn').forEach(btn => {
                btn.classList.toggle('activo', btn.dataset.temaValor === tema);
            });
            
            // Guardar preferencia
            localStorage.setItem('finanzas_tema', tema);
        }

        /**
         * Carga el tema guardado desde localStorage.
         */
        function cargarTema() {
            const temaGuardado = localStorage.getItem('finanzas_tema');
            if (temaGuardado) {
                cambiarTema(temaGuardado);
            }
        }

        // ==================== FUNCIONES DE TABS ====================

        /**
         * Cambia entre las pesta帽as de navegaci贸n
         * @param {string} tabId - ID del tab a mostrar ('movimientos', 'estadisticas', 'configuracion')
         */
        function cambiarTab(tabId) {
            // Ocultar todos los contenidos de tabs
            document.querySelectorAll('.tab-contenido').forEach(tab => {
                tab.classList.remove('activo');
            });
            
            // Desactivar todos los botones de tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('activo');
                btn.setAttribute('aria-selected', 'false');
            });
            
            // Mostrar el contenido del tab seleccionado
            const tabContenido = document.getElementById(`tab-${tabId}`);
            if (tabContenido) {
                tabContenido.classList.add('activo');
            }
            
            // Activar el bot贸n del tab seleccionado
            const tabBtn = document.getElementById(`tab-btn-${tabId}`);
            if (tabBtn) {
                tabBtn.classList.add('activo');
                tabBtn.setAttribute('aria-selected', 'true');
            }
            
            // Si es el tab de estad铆sticas, actualizar los gr谩ficos
            if (tabId === 'estadisticas') {
                setTimeout(() => {
                    actualizarGraficos();
                }, 100);
            }
            
            // Guardar el tab activo en localStorage
            localStorage.setItem('finanzas_tab_activo', tabId);
        }

        /**
         * Restaura el tab activo guardado al cargar la p谩gina
         */
        function restaurarTabActivo() {
            const tabGuardado = localStorage.getItem('finanzas_tab_activo');
            if (tabGuardado) {
                cambiarTab(tabGuardado);
            }
        }

        // ==================== FUNCIONES DE MODAL ACCIN RPIDA ====================

        /**
         * Muestra/oculta el modal de acci贸n r谩pida
         */
        function toggleModalAccionRapida() {
            const modal = document.getElementById('modal-accion-rapida');
            modal.classList.toggle('visible');
            
            // Si se abre el modal, cargar categor铆as y enfocar el primer campo
            if (modal.classList.contains('visible')) {
                actualizarCategoriasRapido();
                document.getElementById('rapido-monto').focus();
            }
        }

        /**
         * Actualiza las categor铆as del modal de acci贸n r谩pida seg煤n el tipo seleccionado
         */
        function actualizarCategoriasRapido() {
            const tipo = document.getElementById('rapido-tipo').value;
            const selectCategoria = document.getElementById('rapido-categoria');
            
            selectCategoria.innerHTML = '';
            
            const categorias = obtenerCategorias(tipo);
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.nombre;
                option.textContent = `${cat.icono} ${cat.nombre}`;
                selectCategoria.appendChild(option);
            });
        }

        /**
         * Agrega un movimiento desde el modal de acci贸n r谩pida
         */
        function agregarMovimientoRapido() {
            const tipo = document.getElementById('rapido-tipo').value;
            const categoria = document.getElementById('rapido-categoria').value;
            const monto = parseFloat(document.getElementById('rapido-monto').value);
            const descripcion = document.getElementById('rapido-descripcion').value.trim();
            
            // Validar
            if (!categoria || isNaN(monto) || monto <= 0) {
                mostrarToast('Error', 'Por favor, completa los campos correctamente', 'error');
                return;
            }
            
            // Crear movimiento
            const nuevoMovimiento = {
                id: Date.now(),
                tipo: tipo,
                categoria: categoria,
                monto: monto,
                fecha: new Date().toISOString().split('T')[0],
                descripcion: descripcion || '-'
            };
            
            // Agregar al array
            movimientos.push(nuevoMovimiento);
            
            // Guardar
            guardarDatosLocalStorage();
            
            // Actualizar UI
            actualizarResumen();
            actualizarTabla();
            actualizarObjetivoAhorro();
            actualizarFiltroCategorias();
            actualizarResumenCategorias();
            actualizarGraficos();
            actualizarPresupuestos();
            renderizarCalendario();
            
            // Cerrar modal y limpiar
            document.getElementById('rapido-monto').value = '';
            document.getElementById('rapido-descripcion').value = '';
            toggleModalAccionRapida();
            
            // Mostrar confirmaci贸n
            const signo = tipo === 'Ingreso' ? '+' : tipo === 'Gasto' ? '-' : '';
            mostrarToast('隆Agregado!', `${signo} ${formatearMoneda(monto)} en ${categoria}`, 'exito');
        }

        // Cerrar modal de acci贸n r谩pida al hacer clic fuera
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('modal-accion-rapida');
            const botonFlotante = document.querySelector('.btn-accion-flotante');
            
            if (modal && modal.classList.contains('visible')) {
                if (!modal.contains(e.target) && e.target !== botonFlotante) {
                    toggleModalAccionRapida();
                }
            }
        });
        
        // ==================== FUNCIONES DE LOCALSTORAGE ====================
        
        /**
         * Guarda los movimientos, categor铆as y el objetivo de ahorro en localStorage.
         * Permite persistir los datos entre sesiones del navegador.
         */
        function guardarDatosLocalStorage() {
            localStorage.setItem('finanzas_movimientos', JSON.stringify(movimientos));
            localStorage.setItem('finanzas_objetivo', objetivoAhorro.toString());
            localStorage.setItem('finanzas_categorias', JSON.stringify(categoriasPersonalizadas));
            localStorage.setItem('finanzas_presupuestos', JSON.stringify(presupuestos));
            localStorage.setItem('finanzas_recurrentes', JSON.stringify(movimientosRecurrentes));
            
            // Auto-guardar en archivo local si est谩 activo
            if (typeof autoGuardarSiActivo === 'function') {
                autoGuardarSiActivo();
            }
        }
        
        /**
         * Carga los datos guardados desde localStorage.
         * Si no hay datos guardados, mantiene los valores por defecto.
         */
        function cargarDatosLocalStorage() {
            const movimientosGuardados = localStorage.getItem('finanzas_movimientos');
            const objetivoGuardado = localStorage.getItem('finanzas_objetivo');
            const categoriasGuardadas = localStorage.getItem('finanzas_categorias');
            const presupuestosGuardados = localStorage.getItem('finanzas_presupuestos');
            const recurrentesGuardados = localStorage.getItem('finanzas_recurrentes');
            
            if (movimientosGuardados) {
                movimientos = JSON.parse(movimientosGuardados);
            }
            
            if (objetivoGuardado) {
                objetivoAhorro = parseFloat(objetivoGuardado);
                document.getElementById('objetivo-monto').value = objetivoAhorro > 0 ? objetivoAhorro : '';
            }

            if (categoriasGuardadas) {
                categoriasPersonalizadas = JSON.parse(categoriasGuardadas);
            }

            if (presupuestosGuardados) {
                presupuestos = JSON.parse(presupuestosGuardados);
            }

            if (recurrentesGuardados) {
                movimientosRecurrentes = JSON.parse(recurrentesGuardados);
            }
        }

        // ==================== FUNCIONES DE CATEGORAS ====================

        /**
         * Obtiene todas las categor铆as (predefinidas + personalizadas) de un tipo.
         * @param {string} tipo - 'Ingreso' o 'Gasto'
         * @returns {Array} - Array de categor铆as con nombre e icono
         */
        function obtenerCategorias(tipo) {
            const predefinidas = categoriasPredefinidas[tipo] || [];
            const personalizadas = categoriasPersonalizadas[tipo] || [];
            return [...predefinidas, ...personalizadas];
        }

        /**
         * Actualiza el select de categor铆as seg煤n el tipo seleccionado en el formulario principal.
         */
        function actualizarCategoriasFormulario() {
            const tipo = document.getElementById('tipo').value;
            const selectCategoria = document.getElementById('categoria');
            
            selectCategoria.innerHTML = '<option value="">Seleccionar...</option>';
            
            if (tipo) {
                const categorias = obtenerCategorias(tipo);
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.nombre;
                    option.textContent = `${cat.icono} ${cat.nombre}`;
                    selectCategoria.appendChild(option);
                });
            }
        }

        /**
         * Actualiza el select de categor铆as en el modal de edici贸n.
         */
        function actualizarCategoriasEditar() {
            const tipo = document.getElementById('editar-tipo').value;
            const selectCategoria = document.getElementById('editar-categoria');
            
            selectCategoria.innerHTML = '';
            
            const categorias = obtenerCategorias(tipo);
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.nombre;
                option.textContent = `${cat.icono} ${cat.nombre}`;
                selectCategoria.appendChild(option);
            });
        }

        /**
         * Agrega una nueva categor铆a personalizada.
         */
        function agregarCategoriaPersonalizada() {
            const tipo = document.getElementById('nueva-categoria-tipo').value;
            const nombre = document.getElementById('nueva-categoria-nombre').value.trim();
            const icono = document.getElementById('nueva-categoria-icono').value.trim() || '';

            if (!nombre) {
                mostrarMensaje('Por favor, ingresa un nombre para la categor铆a.', 'error');
                return;
            }

            // Verificar si ya existe
            const todasCategorias = obtenerCategorias(tipo);
            if (todasCategorias.some(c => c.nombre.toLowerCase() === nombre.toLowerCase())) {
                mostrarMensaje('Esta categor铆a ya existe.', 'error');
                return;
            }

            categoriasPersonalizadas[tipo].push({ nombre, icono });
            guardarDatosLocalStorage();

            // Limpiar campos
            document.getElementById('nueva-categoria-nombre').value = '';
            document.getElementById('nueva-categoria-icono').value = '';

            // Actualizar UI
            renderizarCategoriasPersonalizadas();
            actualizarCategoriasFormulario();
            actualizarFiltroCategorias();

            mostrarMensaje(`Categor铆a "${nombre}" agregada correctamente.`, 'exito');
        }

        /**
         * Elimina una categor铆a personalizada.
         * @param {string} tipo - 'Ingreso' o 'Gasto'
         * @param {string} nombre - Nombre de la categor铆a a eliminar
         */
        function eliminarCategoriaPersonalizada(tipo, nombre) {
            // Verificar si hay movimientos con esta categor铆a
            const movimientosConCategoria = movimientos.filter(m => m.categoria === nombre);
            
            if (movimientosConCategoria.length > 0) {
                if (!confirm(`Hay ${movimientosConCategoria.length} movimiento(s) con esta categor铆a. 驴Deseas eliminarla de todos modos? Los movimientos mantendr谩n el nombre de la categor铆a.`)) {
                    return;
                }
            }

            categoriasPersonalizadas[tipo] = categoriasPersonalizadas[tipo].filter(c => c.nombre !== nombre);
            guardarDatosLocalStorage();

            renderizarCategoriasPersonalizadas();
            actualizarCategoriasFormulario();
            actualizarFiltroCategorias();

            mostrarMensaje('Categor铆a eliminada.', 'exito');
        }

        /**
         * Renderiza las listas de categor铆as en la secci贸n de gesti贸n.
         */
        function renderizarCategoriasPersonalizadas() {
            // Renderizar categor铆as de ingreso
            const listaIngresos = document.getElementById('lista-categorias-ingreso');
            listaIngresos.innerHTML = '';
            
            obtenerCategorias('Ingreso').forEach(cat => {
                const esPersonalizada = categoriasPersonalizadas.Ingreso.some(c => c.nombre === cat.nombre);
                const tag = document.createElement('span');
                tag.className = 'tag-categoria ingreso';
                tag.innerHTML = `
                    ${cat.icono} ${cat.nombre}
                    ${esPersonalizada ? `<span class="eliminar-tag" onclick="eliminarCategoriaPersonalizada('Ingreso', '${cat.nombre}')" title="Eliminar"></span>` : ''}
                `;
                listaIngresos.appendChild(tag);
            });

            // Renderizar categor铆as de gasto
            const listaGastos = document.getElementById('lista-categorias-gasto');
            listaGastos.innerHTML = '';
            
            obtenerCategorias('Gasto').forEach(cat => {
                const esPersonalizada = categoriasPersonalizadas.Gasto.some(c => c.nombre === cat.nombre);
                const tag = document.createElement('span');
                tag.className = 'tag-categoria gasto';
                tag.innerHTML = `
                    ${cat.icono} ${cat.nombre}
                    ${esPersonalizada ? `<span class="eliminar-tag" onclick="eliminarCategoriaPersonalizada('Gasto', '${cat.nombre}')" title="Eliminar"></span>` : ''}
                `;
                listaGastos.appendChild(tag);
            });
        }

        /**
         * Obtiene el icono de una categor铆a por su nombre.
         * @param {string} nombre - Nombre de la categor铆a
         * @returns {string} - Emoji del icono
         */
        function obtenerIconoCategoria(nombre) {
            for (const tipo of ['Ingreso', 'Gasto', 'Ahorro']) {
                const categorias = obtenerCategorias(tipo);
                const cat = categorias.find(c => c.nombre === nombre);
                if (cat) return cat.icono;
            }
            return '';
        }
        
        // ==================== FUNCIONES DE MOVIMIENTOS ====================
        
        /**
         * Agrega un nuevo movimiento al listado.
         * Valida los campos, crea el objeto del movimiento y actualiza la interfaz.
         * @param {Event} evento - Evento del formulario
         */
        function agregarMovimiento(evento) {
            evento.preventDefault();
            
            // Obtener valores del formulario
            const tipo = document.getElementById('tipo').value;
            const categoria = document.getElementById('categoria').value;
            const monto = parseFloat(document.getElementById('monto').value);
            const fecha = document.getElementById('fecha').value;
            const descripcion = document.getElementById('descripcion').value.trim();
            
            // Validar campos requeridos
            if (!validarCampos(tipo, categoria, monto, fecha)) {
                return;
            }
            
            // Crear objeto del nuevo movimiento
            const nuevoMovimiento = {
                id: Date.now(), // ID 煤nico basado en timestamp
                tipo: tipo,
                categoria: categoria,
                monto: monto,
                fecha: fecha,
                descripcion: descripcion || '-'
            };
            
            // Agregar al array de movimientos
            movimientos.push(nuevoMovimiento);
            
            // Guardar en localStorage
            guardarDatosLocalStorage();
            
            // Actualizar toda la interfaz
            actualizarResumen();
            actualizarTabla();
            actualizarObjetivoAhorro();
            actualizarFiltroCategorias();
            actualizarResumenCategorias();
            actualizarGraficos();
            actualizarPresupuestos();
            
            // Limpiar formulario
            document.getElementById('formulario-movimiento').reset();
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = hoy;
            actualizarCategoriasFormulario();
            
            // Mostrar mensaje de 茅xito
            mostrarMensaje('隆Movimiento agregado correctamente!', 'exito');
        }
        
        /**
         * Valida los campos del formulario antes de agregar un movimiento.
         * @param {string} tipo - Tipo de transacci贸n
         * @param {string} categoria - Categor铆a seleccionada
         * @param {number} monto - Monto de la transacci贸n
         * @param {string} fecha - Fecha de la transacci贸n
         * @returns {boolean} - True si todos los campos son v谩lidos
         */
        function validarCampos(tipo, categoria, monto, fecha) {
            // Validar tipo
            if (!tipo) {
                mostrarMensaje('Por favor, selecciona un tipo de transacci贸n.', 'error');
                return false;
            }
            
            // Validar categor铆a
            if (!categoria) {
                mostrarMensaje('Por favor, selecciona una categor铆a.', 'error');
                return false;
            }
            
            // Validar monto
            if (isNaN(monto) || monto <= 0) {
                mostrarMensaje('El monto debe ser un n煤mero positivo.', 'error');
                return false;
            }
            
            // Validar fecha
            if (!fecha) {
                mostrarMensaje('Por favor, selecciona una fecha.', 'error');
                return false;
            }
            
            return true;
        }
        
        /**
         * Elimina un movimiento del listado por su ID.
         * @param {number} id - ID del movimiento a eliminar
         */
        function eliminarMovimiento(id) {
            if (confirm('驴Est谩s seguro de que deseas eliminar este movimiento?')) {
                movimientos = movimientos.filter(m => m.id !== id);
                guardarDatosLocalStorage();
                actualizarResumen();
                actualizarTabla();
                actualizarObjetivoAhorro();
                actualizarResumenCategorias();
                mostrarMensaje('Movimiento eliminado correctamente.', 'exito');
            }
        }

        /**
         * Abre el modal para editar un movimiento.
         * @param {number} id - ID del movimiento a editar
         */
        function abrirModalEditar(id) {
            const mov = movimientos.find(m => m.id === id);
            if (!mov) return;

            document.getElementById('editar-id').value = id;
            document.getElementById('editar-tipo').value = mov.tipo;
            actualizarCategoriasEditar();
            document.getElementById('editar-categoria').value = mov.categoria;
            document.getElementById('editar-monto').value = mov.monto;
            document.getElementById('editar-fecha').value = mov.fecha;
            document.getElementById('editar-descripcion').value = mov.descripcion === '-' ? '' : mov.descripcion;

            document.getElementById('modal-editar').classList.add('activo');
        }

        /**
         * Cierra el modal de edici贸n.
         */
        function cerrarModalEditar() {
            document.getElementById('modal-editar').classList.remove('activo');
        }

        /**
         * Guarda los cambios de edici贸n de un movimiento.
         */
        function guardarEdicion() {
            const id = parseInt(document.getElementById('editar-id').value);
            const tipo = document.getElementById('editar-tipo').value;
            const categoria = document.getElementById('editar-categoria').value;
            const monto = parseFloat(document.getElementById('editar-monto').value);
            const fecha = document.getElementById('editar-fecha').value;
            const descripcion = document.getElementById('editar-descripcion').value.trim();

            if (!validarCampos(tipo, categoria, monto, fecha)) {
                return;
            }

            const index = movimientos.findIndex(m => m.id === id);
            if (index !== -1) {
                movimientos[index] = {
                    ...movimientos[index],
                    tipo,
                    categoria,
                    monto,
                    fecha,
                    descripcion: descripcion || '-'
                };

                guardarDatosLocalStorage();
                actualizarResumen();
                actualizarTabla();
                actualizarObjetivoAhorro();
                actualizarResumenCategorias();
                cerrarModalEditar();
                mostrarMensaje('Movimiento actualizado correctamente.', 'exito');
            }
        }
        
        // ==================== FUNCIONES DE ACTUALIZACIN DE UI ====================
        
        /**
         * Recalcula y actualiza los totales de ingresos, gastos y balance.
         * Filtra los movimientos del mes actual para los c谩lculos.
         */
        function actualizarResumen() {
            const mesActual = new Date().getMonth();
            const anioActual = new Date().getFullYear();
            
            // Filtrar movimientos del mes actual
            const movimientosMes = movimientos.filter(m => {
                const fechaMov = new Date(m.fecha);
                return fechaMov.getMonth() === mesActual && fechaMov.getFullYear() === anioActual;
            });
            
            // Calcular totales
            const movIngreso = movimientosMes.filter(m => m.tipo === 'Ingreso');
            const movGasto = movimientosMes.filter(m => m.tipo === 'Gasto');
            const movAhorro = movimientosMes.filter(m => m.tipo === 'Ahorro');
            
            const ingresos = movIngreso.reduce((sum, m) => sum + m.monto, 0);
            const gastos = movGasto.reduce((sum, m) => sum + m.monto, 0);
            const ahorros = movAhorro.reduce((sum, m) => sum + m.monto, 0);
            
            // Balance = Ingresos - Gastos - Ahorros (el ahorro es dinero apartado, no disponible)
            const balance = ingresos - gastos - ahorros;
            
            // Actualizar elementos del DOM
            document.getElementById('total-ingresos').textContent = formatearMoneda(ingresos);
            document.getElementById('total-gastos').textContent = formatearMoneda(gastos);
            document.getElementById('count-ingresos').textContent = `${movIngreso.length} transaccion${movIngreso.length !== 1 ? 'es' : ''}`;
            document.getElementById('count-gastos').textContent = `${movGasto.length} transaccion${movGasto.length !== 1 ? 'es' : ''}`;
            
            const elementoBalance = document.getElementById('balance');
            elementoBalance.textContent = formatearMoneda(balance);
            elementoBalance.classList.toggle('negativo', balance < 0);

            // Estado del balance
            const estadoBalance = document.getElementById('balance-estado');
            if (balance > 0) {
                estadoBalance.textContent = ' Disponible para gastar';
            } else if (balance < 0) {
                estadoBalance.textContent = '锔 Est谩s en n煤meros rojos';
            } else {
                estadoBalance.textContent = 'Sin saldo disponible';
            }

            // Total hist贸rico de transacciones
            document.getElementById('total-transacciones').textContent = movimientos.length;
        }
        
        /**
         * Renderiza los movimientos en la tabla aplicando filtros, ordenamiento y paginaci贸n.
         * Muestra un mensaje si no hay movimientos que mostrar.
         */
        function actualizarTabla() {
            const cuerpoTabla = document.getElementById('cuerpo-tabla');
            const sinDatos = document.getElementById('sin-datos');
            
            // Obtener movimientos filtrados
            let movimientosFiltrados = obtenerMovimientosFiltrados();
            
            // Aplicar ordenamiento
            movimientosFiltrados = ordenarMovimientos(movimientosFiltrados);
            
            // Limpiar tabla
            cuerpoTabla.innerHTML = '';
            
            // Mostrar mensaje si no hay datos
            if (movimientosFiltrados.length === 0) {
                sinDatos.style.display = 'block';
                ocultarPaginacion();
                return;
            }
            
            sinDatos.style.display = 'none';
            
            // Calcular paginaci贸n
            const totalPaginas = Math.ceil(movimientosFiltrados.length / itemsPorPagina);
            
            // Ajustar p谩gina actual si es necesario
            if (paginaActual > totalPaginas) paginaActual = totalPaginas;
            if (paginaActual < 1) paginaActual = 1;
            
            // Obtener movimientos de la p谩gina actual
            const inicio = (paginaActual - 1) * itemsPorPagina;
            const fin = inicio + itemsPorPagina;
            const movimientosPagina = movimientosFiltrados.slice(inicio, fin);
            
            // Renderizar cada movimiento como fila de la tabla
            movimientosPagina.forEach(mov => {
                const fila = document.createElement('tr');
                fila.className = 'fade-in';
                fila.setAttribute('role', 'row');
                
                // Determinar clases seg煤n el tipo
                let clasesTipo, clasesMonto, signo;
                if (mov.tipo === 'Ingreso') {
                    clasesTipo = 'tipo-ingreso';
                    clasesMonto = 'monto-positivo';
                    signo = '+';
                } else if (mov.tipo === 'Ahorro') {
                    clasesTipo = 'tipo-ahorro';
                    clasesMonto = 'monto-ahorro';
                    signo = ' ';
                } else {
                    clasesTipo = 'tipo-gasto';
                    clasesMonto = 'monto-negativo';
                    signo = '-';
                }
                const icono = obtenerIconoCategoria(mov.categoria);
                
                fila.innerHTML = `
                    <td>${formatearFecha(mov.fecha)}</td>
                    <td class="${clasesTipo}">${mov.tipo}</td>
                    <td>${icono} ${mov.categoria}</td>
                    <td>${mov.descripcion}</td>
                    <td class="${clasesMonto}">${signo}${formatearMoneda(mov.monto)}</td>
                    <td class="acciones-celda">
                        <button class="btn btn-editar" onclick="abrirModalEditar(${mov.id})" aria-label="Editar movimiento">
                            Editar
                        </button>
                        <button class="btn btn-eliminar" onclick="eliminarMovimiento(${mov.id})" aria-label="Eliminar movimiento">
                            Eliminar
                        </button>
                    </td>
                `;
                
                cuerpoTabla.appendChild(fila);
            });
            
            // Renderizar paginaci贸n
            renderizarPaginacion(movimientosFiltrados.length, totalPaginas);
        }

        /**
         * Renderiza los controles de paginaci贸n
         */
        function renderizarPaginacion(totalItems, totalPaginas) {
            let paginacionContainer = document.getElementById('paginacion-container');
            
            if (!paginacionContainer) {
                paginacionContainer = document.createElement('div');
                paginacionContainer.id = 'paginacion-container';
                paginacionContainer.className = 'paginacion';
                paginacionContainer.setAttribute('role', 'navigation');
                paginacionContainer.setAttribute('aria-label', 'Paginaci贸n de movimientos');
                document.querySelector('.tabla-container').appendChild(paginacionContainer);
            }
            
            if (totalPaginas <= 1) {
                paginacionContainer.style.display = 'none';
                return;
            }
            
            paginacionContainer.style.display = 'flex';
            
            const inicioItem = (paginaActual - 1) * itemsPorPagina + 1;
            const finItem = Math.min(paginaActual * itemsPorPagina, totalItems);
            
            let botonesHTML = '';
            botonesHTML += `<button class="paginacion-btn" onclick="cambiarPagina(${paginaActual - 1})" ${paginaActual === 1 ? 'disabled' : ''} aria-label="P谩gina anterior"></button>`;
            
            const maxBotones = 5;
            let inicioBtn = Math.max(1, paginaActual - Math.floor(maxBotones / 2));
            let finBtn = Math.min(totalPaginas, inicioBtn + maxBotones - 1);
            
            if (finBtn - inicioBtn < maxBotones - 1) {
                inicioBtn = Math.max(1, finBtn - maxBotones + 1);
            }
            
            if (inicioBtn > 1) {
                botonesHTML += `<button class="paginacion-btn" onclick="cambiarPagina(1)">1</button>`;
                if (inicioBtn > 2) botonesHTML += `<span style="padding: 0 5px;">...</span>`;
            }
            
            for (let i = inicioBtn; i <= finBtn; i++) {
                botonesHTML += `<button class="paginacion-btn ${i === paginaActual ? 'activo' : ''}" onclick="cambiarPagina(${i})" ${i === paginaActual ? 'aria-current="page"' : ''}>${i}</button>`;
            }
            
            if (finBtn < totalPaginas) {
                if (finBtn < totalPaginas - 1) botonesHTML += `<span style="padding: 0 5px;">...</span>`;
                botonesHTML += `<button class="paginacion-btn" onclick="cambiarPagina(${totalPaginas})">${totalPaginas}</button>`;
            }
            
            botonesHTML += `<button class="paginacion-btn" onclick="cambiarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas ? 'disabled' : ''} aria-label="P谩gina siguiente"></button>`;
            
            paginacionContainer.innerHTML = `
                <span class="paginacion-info">Mostrando ${inicioItem}-${finItem} de ${totalItems} movimientos</span>
                <div class="paginacion-botones">${botonesHTML}</div>
            `;
        }

        /**
         * Cambia a una p谩gina espec铆fica
         */
        function cambiarPagina(pagina) {
            paginaActual = pagina;
            actualizarTabla();
            document.getElementById('tabla-movimientos').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * Oculta la paginaci贸n cuando no hay datos
         */
        function ocultarPaginacion() {
            const paginacionContainer = document.getElementById('paginacion-container');
            if (paginacionContainer) {
                paginacionContainer.style.display = 'none';
            }
        }
        
        /**
         * Recalcula el porcentaje de cumplimiento del objetivo de ahorro.
         * Actualiza la barra de progreso y los indicadores visuales.
         * Ahora cuenta los movimientos de tipo "Ahorro" directamente.
         */
        function actualizarObjetivoAhorro() {
            const mesActual = new Date().getMonth();
            const anioActual = new Date().getFullYear();
            
            // Filtrar movimientos del mes actual
            const movimientosMes = movimientos.filter(m => {
                const fechaMov = new Date(m.fecha);
                return fechaMov.getMonth() === mesActual && fechaMov.getFullYear() === anioActual;
            });
            
            // Calcular ahorro del mes (movimientos tipo "Ahorro")
            const ahorrosRegistrados = movimientosMes
                .filter(m => m.tipo === 'Ahorro')
                .reduce((sum, m) => sum + m.monto, 0);
            
            // Tambi茅n calcular el ahorro impl铆cito (ingresos - gastos) para referencia
            const ingresos = movimientosMes
                .filter(m => m.tipo === 'Ingreso')
                .reduce((sum, m) => sum + m.monto, 0);
            
            const gastos = movimientosMes
                .filter(m => m.tipo === 'Gasto')
                .reduce((sum, m) => sum + m.monto, 0);
            
            // El ahorro total es lo que registraste expl铆citamente como ahorro
            const ahorrado = ahorrosRegistrados;
            
            // Calcular porcentaje
            let porcentaje = 0;
            if (objetivoAhorro > 0) {
                porcentaje = Math.min(100, (ahorrado / objetivoAhorro) * 100);
            }
            
            // Actualizar elementos del DOM
            document.getElementById('monto-ahorrado').textContent = formatearMoneda(ahorrado);
            document.getElementById('meta-ahorro').textContent = formatearMoneda(objetivoAhorro);
            document.getElementById('progreso-relleno').style.width = `${porcentaje}%`;
            document.getElementById('progreso-porcentaje').textContent = `${porcentaje.toFixed(1)}%`;
            document.getElementById('ahorro-porcentaje').textContent = `${porcentaje.toFixed(1)}%`;

            // Estado del ahorro
            const estadoAhorro = document.getElementById('ahorro-estado');
            if (objetivoAhorro === 0) {
                estadoAhorro.textContent = 'Sin objetivo definido';
            } else if (porcentaje >= 100) {
                estadoAhorro.textContent = '隆Meta alcanzada! ';
            } else if (porcentaje >= 50) {
                estadoAhorro.textContent = '隆Vas por buen camino!';
            } else {
                estadoAhorro.textContent = `Faltan ${formatearMoneda(objetivoAhorro - ahorrado)}`;
            }
        }
        
        /**
         * Guarda el objetivo de ahorro ingresado por el usuario.
         */
        function guardarObjetivo() {
            const montoObjetivo = parseFloat(document.getElementById('objetivo-monto').value);
            
            if (isNaN(montoObjetivo) || montoObjetivo < 0) {
                mostrarMensaje('Por favor, ingresa un monto v谩lido para el objetivo.', 'error');
                return;
            }
            
            objetivoAhorro = montoObjetivo;
            guardarDatosLocalStorage();
            actualizarObjetivoAhorro();
            mostrarMensaje('隆Objetivo de ahorro establecido correctamente!', 'exito');
        }

        /**
         * Actualiza el resumen visual por categor铆as del mes actual.
         */
        function actualizarResumenCategorias() {
            const mesActual = new Date().getMonth();
            const anioActual = new Date().getFullYear();
            
            const movimientosMes = movimientos.filter(m => {
                const fechaMov = new Date(m.fecha);
                return fechaMov.getMonth() === mesActual && fechaMov.getFullYear() === anioActual;
            });

            // Agrupar por categor铆a
            const porCategoria = {};
            movimientosMes.forEach(m => {
                if (!porCategoria[m.categoria]) {
                    porCategoria[m.categoria] = { total: 0, tipo: m.tipo };
                }
                porCategoria[m.categoria].total += m.monto;
            });

            const contenedor = document.getElementById('resumen-categorias');
            const sinCategorias = document.getElementById('sin-categorias');

            if (Object.keys(porCategoria).length === 0) {
                contenedor.innerHTML = '';
                sinCategorias.style.display = 'block';
                return;
            }

            sinCategorias.style.display = 'none';

            // Calcular m谩ximo para las barras
            const maxMonto = Math.max(...Object.values(porCategoria).map(c => c.total));

            // Ordenar por monto descendente
            const categoriasOrdenadas = Object.entries(porCategoria).sort((a, b) => b[1].total - a[1].total);

            contenedor.innerHTML = categoriasOrdenadas.map(([nombre, data]) => {
                const icono = obtenerIconoCategoria(nombre);
                const porcentajeBarra = (data.total / maxMonto) * 100;
                const esGasto = data.tipo === 'Gasto';
                
                return `
                    <div class="categoria-item fade-in">
                        <div class="categoria-icono">${icono}</div>
                        <div class="categoria-info">
                            <div class="categoria-nombre">${nombre}</div>
                            <div class="categoria-barra">
                                <div class="categoria-barra-relleno ${esGasto ? 'gasto' : 'ingreso'}" style="width: ${porcentajeBarra}%"></div>
                            </div>
                        </div>
                        <div class="categoria-monto ${esGasto ? 'gasto' : 'ingreso'}">${esGasto ? '-' : '+'}${formatearMoneda(data.total)}</div>
                    </div>
                `;
            }).join('');
        }
        
        // ==================== FUNCIONES DE FILTRADO Y ORDENAMIENTO ====================
        
        /**
         * Obtiene los movimientos filtrados seg煤n los criterios seleccionados.
         * @returns {Array} - Array de movimientos filtrados
         */
        function obtenerMovimientosFiltrados() {
            const filtroTipo = document.getElementById('filtro-tipo').value;
            const filtroCategoria = document.getElementById('filtro-categoria').value;
            const filtroFechaDesde = document.getElementById('filtro-fecha-desde').value;
            const filtroFechaHasta = document.getElementById('filtro-fecha-hasta').value;
            const filtroBusqueda = document.getElementById('filtro-busqueda').value.toLowerCase();
            
            return movimientos.filter(m => {
                const cumpleTipo = !filtroTipo || m.tipo === filtroTipo;
                const cumpleCategoria = !filtroCategoria || m.categoria === filtroCategoria;
                const cumpleFechaDesde = !filtroFechaDesde || m.fecha >= filtroFechaDesde;
                const cumpleFechaHasta = !filtroFechaHasta || m.fecha <= filtroFechaHasta;
                const cumpleBusqueda = !filtroBusqueda || 
                    m.descripcion.toLowerCase().includes(filtroBusqueda) ||
                    m.categoria.toLowerCase().includes(filtroBusqueda);
                return cumpleTipo && cumpleCategoria && cumpleFechaDesde && cumpleFechaHasta && cumpleBusqueda;
            });
        }
        
        /**
         * Aplica los filtros seleccionados y actualiza la tabla.
         * Usa debounce para b煤squeda de texto
         */
        function aplicarFiltros() {
            paginaActual = 1; // Resetear a primera p谩gina al filtrar
            actualizarTabla();
        }

        /**
         * Aplica filtros con debounce para la b煤squeda de texto
         */
        function aplicarFiltrosConDebounce() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                paginaActual = 1;
                actualizarTabla();
            }, 300);
        }
        
        /**
         * Limpia todos los filtros y muestra todos los movimientos.
         */
        function limpiarFiltros() {
            document.getElementById('filtro-tipo').value = '';
            document.getElementById('filtro-categoria').value = '';
            document.getElementById('filtro-fecha-desde').value = '';
            document.getElementById('filtro-fecha-hasta').value = '';
            document.getElementById('filtro-busqueda').value = '';
            paginaActual = 1;
            actualizarTabla();
        }
        
        /**
         * Actualiza las opciones del filtro de categor铆as bas谩ndose en los movimientos existentes.
         */
        function actualizarFiltroCategorias() {
            const selectCategoria = document.getElementById('filtro-categoria');
            const categorias = [...new Set(movimientos.map(m => m.categoria))];
            
            // Mantener el valor seleccionado si existe
            const valorActual = selectCategoria.value;
            
            // Reconstruir opciones
            selectCategoria.innerHTML = '<option value="">Todas</option>';
            categorias.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                const icono = obtenerIconoCategoria(cat);
                option.textContent = `${icono} ${cat}`;
                selectCategoria.appendChild(option);
            });
            
            // Restaurar selecci贸n si es v谩lida
            if (categorias.includes(valorActual)) {
                selectCategoria.value = valorActual;
            }
        }
        
        /**
         * Ordena los movimientos seg煤n el campo y direcci贸n especificados.
         * @param {Array} movimientos - Array de movimientos a ordenar
         * @returns {Array} - Array de movimientos ordenados
         */
        function ordenarMovimientos(movimientos) {
            const { campo, direccion } = ordenActual;
            
            return [...movimientos].sort((a, b) => {
                let valorA = a[campo];
                let valorB = b[campo];
                
                // Convertir a n煤meros para comparaci贸n de montos
                if (campo === 'monto') {
                    valorA = parseFloat(valorA);
                    valorB = parseFloat(valorB);
                }
                
                // Comparaci贸n
                if (valorA < valorB) return direccion === 'asc' ? -1 : 1;
                if (valorA > valorB) return direccion === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        /**
         * Cambia el ordenamiento de la tabla al hacer clic en un encabezado.
         * @param {string} campo - Campo por el cual ordenar
         */
        function ordenarTabla(campo) {
            // Limpiar indicadores anteriores
            document.querySelectorAll('th').forEach(th => th.classList.remove('ordenado'));
            document.querySelectorAll('.flecha').forEach(f => f.textContent = '');
            
            // Alternar direcci贸n si es el mismo campo
            if (ordenActual.campo === campo) {
                ordenActual.direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
            } else {
                ordenActual.campo = campo;
                ordenActual.direccion = 'desc';
            }
            
            // Actualizar indicador visual
            const flecha = document.getElementById(`flecha-${campo}`);
            if (flecha) {
                flecha.textContent = ordenActual.direccion === 'asc' ? '' : '';
                flecha.parentElement.classList.add('ordenado');
            }
            
            actualizarTabla();
        }

        // ==================== FUNCIONES DE EXPORTACIN ====================

        /**
         * Exporta los movimientos a un archivo CSV.
         */
        function exportarCSV() {
            if (movimientos.length === 0) {
                mostrarMensaje('No hay movimientos para exportar.', 'error');
                return;
            }

            const headers = ['Fecha', 'Tipo', 'Categor铆a', 'Descripci贸n', 'Monto'];
            const filas = movimientos.map(m => [
                m.fecha,
                m.tipo,
                m.categoria,
                `"${m.descripcion.replace(/"/g, '""')}"`,
                m.monto
            ]);

            const csv = [headers.join(','), ...filas.map(f => f.join(','))].join('\n');
            descargarArchivo(csv, 'finanzas_movimientos.csv', 'text/csv');
            mostrarMensaje('Archivo CSV exportado correctamente.', 'exito');
        }

        /**
         * Descarga un archivo con el contenido especificado.
         * @param {string} contenido - Contenido del archivo
         * @param {string} nombreArchivo - Nombre del archivo
         * @param {string} tipo - Tipo MIME del archivo
         */
        function descargarArchivo(contenido, nombreArchivo, tipo) {
            const blob = new Blob([contenido], { type: tipo });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Limpia todos los datos de la aplicaci贸n.
         */
        function limpiarTodosDatos() {
            if (confirm('锔 驴Est谩s seguro de que deseas eliminar TODOS los datos?\n\nEsta acci贸n eliminar谩:\n- Todos los movimientos\n- El objetivo de ahorro\n- Las categor铆as personalizadas\n\nEsta acci贸n no se puede deshacer.')) {
                if (confirm('Esta es tu 煤ltima oportunidad. 驴Realmente deseas eliminar todo?')) {
                    movimientos = [];
                    objetivoAhorro = 0;
                    categoriasPersonalizadas = { Ingreso: [], Gasto: [] };
                    
                    localStorage.removeItem('finanzas_movimientos');
                    localStorage.removeItem('finanzas_objetivo');
                    localStorage.removeItem('finanzas_categorias');

                    document.getElementById('objetivo-monto').value = '';
                    
                    actualizarResumen();
                    actualizarTabla();
                    actualizarObjetivoAhorro();
                    actualizarFiltroCategorias();
                    actualizarResumenCategorias();
                    renderizarCategoriasPersonalizadas();
                    actualizarCategoriasFormulario();

                    mostrarMensaje('Todos los datos han sido eliminados.', 'exito');
                }
            }
        }
        
        // ==================== FUNCIONES AUXILIARES ====================
        
        /**
         * Formatea un n煤mero como moneda con separadores de miles.
         * @param {number} monto - Monto a formatear
         * @returns {string} - Monto formateado como moneda
         */
        function formatearMoneda(monto) {
            return '$' + monto.toLocaleString('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
        
        /**
         * Formatea una fecha en formato legible (d铆a/mes/a帽o).
         * @param {string} fecha - Fecha en formato ISO
         * @returns {string} - Fecha formateada
         */
        function formatearFecha(fecha) {
            const opciones = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(fecha + 'T00:00:00').toLocaleDateString('es-ES', opciones);
        }
        
        /**
         * Muestra un mensaje temporal al usuario.
         * @param {string} texto - Texto del mensaje
         * @param {string} tipo - Tipo de mensaje ('exito' o 'error')
         */
        function mostrarMensaje(texto, tipo) {
            const mensaje = document.getElementById('mensaje');
            mensaje.textContent = texto;
            mensaje.className = `mensaje ${tipo}`;
            
            // Ocultar despu茅s de 3 segundos
            setTimeout(() => {
                mensaje.className = 'mensaje';
            }, 3000);
        }

        // Cerrar modal al hacer clic fuera de 茅l
        document.getElementById('modal-editar').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalEditar();
            }
        });

        // ==================== FUNCIONES DE GRFICOS ====================

        /**
         * Inicializa los selectores de per铆odo y crea los gr谩ficos
         */
        function inicializarGraficos() {
            // Llenar selector de meses
            const selectMes = document.getElementById('grafico-mes');
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const mesActual = new Date().getMonth();
            meses.forEach((mes, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = mes;
                if (index === mesActual) option.selected = true;
                selectMes.appendChild(option);
            });

            // Llenar selector de a帽os
            const selectAnio = document.getElementById('grafico-anio');
            const anioActual = new Date().getFullYear();
            for (let anio = anioActual - 5; anio <= anioActual + 1; anio++) {
                const option = document.createElement('option');
                option.value = anio;
                option.textContent = anio;
                if (anio === anioActual) option.selected = true;
                selectAnio.appendChild(option);
            }

            actualizarGraficos();
        }

        /**
         * Actualiza todos los gr谩ficos con los datos del per铆odo seleccionado
         */
        function actualizarGraficos() {
            const mes = parseInt(document.getElementById('grafico-mes').value);
            const anio = parseInt(document.getElementById('grafico-anio').value);

            // Filtrar movimientos del per铆odo
            const movimientosPeriodo = movimientos.filter(m => {
                const fecha = new Date(m.fecha);
                return fecha.getMonth() === mes && fecha.getFullYear() === anio;
            });

            // Destruir gr谩ficos anteriores si existen
            Object.values(graficos).forEach(g => g.destroy());
            graficos = {};

            // Gr谩fico de distribuci贸n de gastos
            crearGraficoGastos(movimientosPeriodo);
            
            // Gr谩fico de ingresos vs gastos
            crearGraficoBalance(movimientosPeriodo);
            
            // Gr谩fico de tendencia mensual
            crearGraficoTendencia();
            
            // Gr谩fico de distribuci贸n de ingresos
            crearGraficoIngresos(movimientosPeriodo);
        }

        function crearGraficoGastos(movimientos) {
            const gastos = movimientos.filter(m => m.tipo === 'Gasto');
            const porCategoria = {};
            
            gastos.forEach(m => {
                porCategoria[m.categoria] = (porCategoria[m.categoria] || 0) + m.monto;
            });

            const ctx = document.getElementById('grafico-gastos').getContext('2d');
            graficos.gastos = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(porCategoria),
                    datasets: [{
                        data: Object.values(porCategoria),
                        backgroundColor: [
                            '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                            '#1abc9c', '#e91e63', '#00bcd4', '#ff9800', '#795548'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12 } }
                    }
                }
            });
        }

        function crearGraficoIngresos(movimientos) {
            const ingresos = movimientos.filter(m => m.tipo === 'Ingreso');
            const porCategoria = {};
            
            ingresos.forEach(m => {
                porCategoria[m.categoria] = (porCategoria[m.categoria] || 0) + m.monto;
            });

            const ctx = document.getElementById('grafico-ingresos').getContext('2d');
            graficos.ingresos = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(porCategoria),
                    datasets: [{
                        data: Object.values(porCategoria),
                        backgroundColor: [
                            '#2ecc71', '#27ae60', '#1abc9c', '#16a085', '#3498db',
                            '#2980b9', '#9b59b6', '#8e44ad', '#f39c12', '#e67e22'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12 } }
                    }
                }
            });
        }

        function crearGraficoBalance(movimientos) {
            const ingresos = movimientos.filter(m => m.tipo === 'Ingreso')
                .reduce((sum, m) => sum + m.monto, 0);
            const gastos = movimientos.filter(m => m.tipo === 'Gasto')
                .reduce((sum, m) => sum + m.monto, 0);

            const ctx = document.getElementById('grafico-balance').getContext('2d');
            graficos.balance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Gastos', 'Balance'],
                    datasets: [{
                        data: [ingresos, gastos, ingresos - gastos],
                        backgroundColor: ['#2ecc71', '#e74c3c', ingresos - gastos >= 0 ? '#3498db' : '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function crearGraficoTendencia() {
            const ultimos6Meses = [];
            const ingresosMes = [];
            const gastosMes = [];
            
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date();
                fecha.setMonth(fecha.getMonth() - i);
                const mes = fecha.getMonth();
                const anio = fecha.getFullYear();
                
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                              'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                ultimos6Meses.push(meses[mes]);
                
                const movsMes = movimientos.filter(m => {
                    const f = new Date(m.fecha);
                    return f.getMonth() === mes && f.getFullYear() === anio;
                });
                
                ingresosMes.push(movsMes.filter(m => m.tipo === 'Ingreso')
                    .reduce((sum, m) => sum + m.monto, 0));
                gastosMes.push(movsMes.filter(m => m.tipo === 'Gasto')
                    .reduce((sum, m) => sum + m.monto, 0));
            }

            const ctx = document.getElementById('grafico-tendencia').getContext('2d');
            graficos.tendencia = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ultimos6Meses,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: ingresosMes,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Gastos',
                            data: gastosMes,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // ==================== FUNCIONES DE PRESUPUESTOS ====================

        /**
         * Ya no se necesita - el sistema es autom谩tico
         */
        function cargarCategoriasPresupuesto() {
            // Funci贸n vac铆a para compatibilidad
        }

        /**
         * Calcula el promedio de gastos de los 煤ltimos 3 meses por categor铆a
         */
        function calcularPromedioGastos() {
            const promedios = {};
            const hoy = new Date();
            
            // Obtener todas las categor铆as que han tenido gastos
            const categoriasUsadas = [...new Set(movimientos
                .filter(m => m.tipo === 'Gasto')
                .map(m => m.categoria))];
            
            categoriasUsadas.forEach(categoria => {
                const gastosPorMes = [];
                
                // Revisar los 煤ltimos 3 meses (sin contar el actual)
                for (let i = 1; i <= 3; i++) {
                    const fecha = new Date(hoy);
                    fecha.setMonth(fecha.getMonth() - i);
                    const mes = fecha.getMonth();
                    const anio = fecha.getFullYear();
                    
                    const gastoMes = movimientos
                        .filter(m => {
                            const f = new Date(m.fecha);
                            return m.tipo === 'Gasto' && 
                                   m.categoria === categoria && 
                                   f.getMonth() === mes && 
                                   f.getFullYear() === anio;
                        })
                        .reduce((sum, m) => sum + m.monto, 0);
                    
                    if (gastoMes > 0) {
                        gastosPorMes.push(gastoMes);
                    }
                }
                
                // Calcular promedio si hay datos hist贸ricos
                if (gastosPorMes.length > 0) {
                    promedios[categoria] = Math.round(gastosPorMes.reduce((a, b) => a + b, 0) / gastosPorMes.length);
                }
            });
            
            return promedios;
        }

        /**
         * Actualiza la visualizaci贸n de presupuestos autom谩ticos
         */
        function actualizarPresupuestos() {
            const contenedor = document.getElementById('presupuestos-lista');
            const sinPresupuestos = document.getElementById('sin-presupuestos');
            const mesActual = new Date().getMonth();
            const anioActual = new Date().getFullYear();

            // Calcular gastos del mes actual por categor铆a
            const gastosMesActual = {};
            movimientos.filter(m => {
                const fecha = new Date(m.fecha);
                return m.tipo === 'Gasto' && fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual;
            }).forEach(m => {
                gastosMesActual[m.categoria] = (gastosMesActual[m.categoria] || 0) + m.monto;
            });

            // Si no hay gastos este mes, mostrar mensaje
            if (Object.keys(gastosMesActual).length === 0) {
                contenedor.innerHTML = '';
                sinPresupuestos.style.display = 'block';
                return;
            }

            sinPresupuestos.style.display = 'none';

            // Calcular promedios hist贸ricos
            const promedios = calcularPromedioGastos();

            // Generar cards para cada categor铆a con gastos este mes
            contenedor.innerHTML = Object.entries(gastosMesActual)
                .sort((a, b) => b[1] - a[1]) // Ordenar por monto descendente
                .map(([categoria, gastado]) => {
                    const icono = obtenerIconoCategoria(categoria);
                    const promedio = promedios[categoria] || gastado; // Si no hay hist贸rico, usar el actual
                    const porcentaje = Math.min((gastado / promedio) * 100, 150); // Max 150% para visualizaci贸n
                    
                    let estado = 'normal';
                    let estadoTexto = '';
                    let comparacion = '';
                    
                    if (promedios[categoria]) {
                        const diferencia = gastado - promedio;
                        if (diferencia > 0) {
                            const porcentajeExceso = ((diferencia / promedio) * 100).toFixed(0);
                            if (porcentaje >= 100) {
                                estado = 'excedido';
                                estadoTexto = `锔 +${formatearMoneda(diferencia)} sobre el promedio`;
                            } else if (porcentaje >= 80) {
                                estado = 'advertencia';
                                estadoTexto = `Cerca del promedio habitual`;
                            }
                        } else {
                            estado = 'normal';
                            estadoTexto = ` ${formatearMoneda(Math.abs(diferencia))} menos que el promedio`;
                        }
                        comparacion = `Promedio: ${formatearMoneda(promedio)}`;
                    } else {
                        estadoTexto = ' Primera vez en esta categor铆a';
                        comparacion = 'Sin historial previo';
                    }

                    return `
                        <div class="presupuesto-item">
                            <div class="presupuesto-header">
                                <span class="presupuesto-categoria">${icono} ${categoria}</span>
                            </div>
                            <div class="presupuesto-valores">
                                <span>Gastado: ${formatearMoneda(gastado)}</span>
                                <span>${comparacion}</span>
                            </div>
                            <div class="presupuesto-barra">
                                <div class="presupuesto-barra-relleno ${estado}" style="width: ${Math.min(porcentaje, 100)}%"></div>
                            </div>
                            <div class="presupuesto-estado ${estado}">${estadoTexto}</div>
                        </div>
                    `;
                }).join('');
        }

        // ==================== FUNCIONES DE MOVIMIENTOS RECURRENTES ====================

        /**
         * Actualiza el selector de categor铆as para movimientos recurrentes
         */
        function actualizarCategoriasRecurrente() {
            const tipo = document.getElementById('recurrente-tipo').value;
            const select = document.getElementById('recurrente-categoria');
            select.innerHTML = '';
            
            const categorias = obtenerCategorias(tipo);
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.nombre;
                option.textContent = `${cat.icono} ${cat.nombre}`;
                select.appendChild(option);
            });
        }

        /**
         * Agrega un nuevo movimiento recurrente
         */
        function agregarRecurrente() {
            const tipo = document.getElementById('recurrente-tipo').value;
            const categoria = document.getElementById('recurrente-categoria').value;
            const descripcion = document.getElementById('recurrente-descripcion').value.trim();
            const monto = parseFloat(document.getElementById('recurrente-monto').value);
            const frecuencia = document.getElementById('recurrente-frecuencia').value;
            const dia = parseInt(document.getElementById('recurrente-dia').value);

            if (!descripcion || isNaN(monto) || monto <= 0) {
                mostrarMensaje('Por favor, completa todos los campos correctamente.', 'error');
                return;
            }

            const recurrente = {
                id: Date.now(),
                tipo,
                categoria,
                descripcion,
                monto,
                frecuencia,
                dia,
                ultimaEjecucion: null,
                activo: true
            };

            movimientosRecurrentes.push(recurrente);
            guardarDatosLocalStorage();
            actualizarRecurrentes();
            
            // Limpiar formulario
            document.getElementById('recurrente-descripcion').value = '';
            document.getElementById('recurrente-monto').value = '';
            mostrarMensaje('Movimiento recurrente agregado.', 'exito');
        }

        /**
         * Elimina un movimiento recurrente
         */
        function eliminarRecurrente(id) {
            if (confirm('驴Eliminar este movimiento recurrente?')) {
                movimientosRecurrentes = movimientosRecurrentes.filter(r => r.id !== id);
                guardarDatosLocalStorage();
                actualizarRecurrentes();
            }
        }

        /**
         * Ejecuta manualmente un movimiento recurrente
         */
        function ejecutarRecurrente(id) {
            const recurrente = movimientosRecurrentes.find(r => r.id === id);
            if (!recurrente) return;

            const nuevoMovimiento = {
                id: Date.now(),
                tipo: recurrente.tipo,
                categoria: recurrente.categoria,
                monto: recurrente.monto,
                fecha: new Date().toISOString().split('T')[0],
                descripcion: `${recurrente.descripcion} (Recurrente)`
            };

            movimientos.push(nuevoMovimiento);
            recurrente.ultimaEjecucion = new Date().toISOString();
            guardarDatosLocalStorage();
            
            actualizarResumen();
            actualizarTabla();
            actualizarRecurrentes();
            actualizarGraficos();
            actualizarPresupuestos();
            mostrarMensaje('Movimiento recurrente ejecutado.', 'exito');
        }

        /**
         * Actualiza la visualizaci贸n de movimientos recurrentes
         */
        function actualizarRecurrentes() {
            const contenedor = document.getElementById('recurrentes-lista');
            const sinRecurrentes = document.getElementById('sin-recurrentes');

            if (movimientosRecurrentes.length === 0) {
                contenedor.innerHTML = '';
                sinRecurrentes.style.display = 'block';
                return;
            }

            sinRecurrentes.style.display = 'none';
            const frecuenciasTexto = {
                semanal: 'Semanal',
                quincenal: 'Quincenal',
                mensual: 'Mensual',
                anual: 'Anual'
            };

            contenedor.innerHTML = movimientosRecurrentes.map(r => {
                const icono = obtenerIconoCategoria(r.categoria);
                return `
                    <div class="recurrente-item">
                        <div class="recurrente-info">
                            <span class="recurrente-icono">${icono}</span>
                            <div class="recurrente-detalles">
                                <h4>${r.descripcion}</h4>
                                <span>${r.categoria}  D铆a ${r.dia}</span>
                            </div>
                        </div>
                        <span class="frecuencia-badge">${frecuenciasTexto[r.frecuencia]}</span>
                        <span class="recurrente-monto ${r.tipo.toLowerCase()}">${r.tipo === 'Ingreso' ? '+' : '-'}${formatearMoneda(r.monto)}</span>
                        <div class="acciones-celda">
                            <button class="btn btn-editar" onclick="ejecutarRecurrente(${r.id})"> Ejecutar</button>
                            <button class="btn btn-eliminar" onclick="eliminarRecurrente(${r.id})"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Verifica si hay movimientos recurrentes pendientes de ejecutar
         */
        function verificarRecurrentesPendientes() {
            const hoy = new Date();
            const diaHoy = hoy.getDate();
            
            movimientosRecurrentes.forEach(r => {
                if (!r.activo) return;
                
                const debeEjecutar = r.dia === diaHoy;
                const yaEjecutadoHoy = r.ultimaEjecucion && 
                    new Date(r.ultimaEjecucion).toDateString() === hoy.toDateString();
                
                if (debeEjecutar && !yaEjecutadoHoy) {
                    // Notificar al usuario que hay movimientos pendientes
                    console.log(`Movimiento recurrente pendiente: ${r.descripcion}`);
                }
            });
        }

        // ==================== FUNCIONES DE IMPORTACIN ====================

        /**
         * Configura los eventos de arrastrar y soltar para importaci贸n
         */
        function configurarImportacion() {
            const zona = document.getElementById('zona-importar');
            
            zona.addEventListener('dragover', (e) => {
                e.preventDefault();
                zona.classList.add('arrastrando');
            });
            
            zona.addEventListener('dragleave', () => {
                zona.classList.remove('arrastrando');
            });
            
            zona.addEventListener('drop', (e) => {
                e.preventDefault();
                zona.classList.remove('arrastrando');
                
                const archivo = e.dataTransfer.files[0];
                if (archivo) {
                    procesarArchivoImportado(archivo);
                }
            });
        }

        /**
         * Maneja el evento de selecci贸n de archivo
         */
        function importarArchivo(event) {
            const archivo = event.target.files[0];
            if (archivo) {
                procesarArchivoImportado(archivo);
            }
        }

        /**
         * Procesa el archivo importado (JSON o CSV)
         */
        function procesarArchivoImportado(archivo) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const contenido = e.target.result;
                const extension = archivo.name.split('.').pop().toLowerCase();
                
                try {
                    if (extension === 'json') {
                        importarJSON(contenido);
                    } else if (extension === 'csv') {
                        importarCSV(contenido);
                    } else {
                        mostrarMensaje('Formato de archivo no soportado.', 'error');
                    }
                } catch (error) {
                    mostrarMensaje('Error al procesar el archivo: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(archivo);
        }

        /**
         * Importa datos desde un archivo JSON
         */
        function importarJSON(contenido) {
            const datos = JSON.parse(contenido);
            
            if (datos.movimientos) {
                const confirmar = confirm(`Se importar谩n ${datos.movimientos.length} movimientos. 驴Deseas reemplazar los datos actuales o agregar a los existentes?\n\nAceptar = Reemplazar\nCancelar = Agregar`);
                
                if (confirmar) {
                    movimientos = datos.movimientos;
                } else {
                    // Agregar evitando duplicados por ID
                    const idsExistentes = new Set(movimientos.map(m => m.id));
                    datos.movimientos.forEach(m => {
                        if (!idsExistentes.has(m.id)) {
                            movimientos.push(m);
                        }
                    });
                }
            }
            
            if (datos.objetivoAhorro !== undefined) {
                objetivoAhorro = datos.objetivoAhorro;
                document.getElementById('objetivo-monto').value = objetivoAhorro;
            }
            
            if (datos.categoriasPersonalizadas) {
                categoriasPersonalizadas = datos.categoriasPersonalizadas;
            }

            if (datos.presupuestos) {
                presupuestos = datos.presupuestos;
            }

            if (datos.movimientosRecurrentes) {
                movimientosRecurrentes = datos.movimientosRecurrentes;
            }
            
            guardarDatosLocalStorage();
            actualizarTodo();
            mostrarMensaje('Datos importados correctamente.', 'exito');
        }

        /**
         * Importa movimientos desde un archivo CSV
         */
        function importarCSV(contenido) {
            const lineas = contenido.split('\n').filter(l => l.trim());
            const cabecera = lineas[0].toLowerCase();
            
            // Detectar si tiene cabecera
            const tieneCabecera = cabecera.includes('fecha') || cabecera.includes('tipo');
            const inicio = tieneCabecera ? 1 : 0;
            
            const nuevosMovimientos = [];
            
            for (let i = inicio; i < lineas.length; i++) {
                const valores = lineas[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                
                if (valores.length >= 5) {
                    nuevosMovimientos.push({
                        id: Date.now() + i,
                        fecha: valores[0],
                        tipo: valores[1],
                        categoria: valores[2],
                        descripcion: valores[3] || '-',
                        monto: parseFloat(valores[4]) || 0
                    });
                }
            }
            
            if (nuevosMovimientos.length === 0) {
                mostrarMensaje('No se encontraron movimientos v谩lidos en el CSV.', 'error');
                return;
            }
            
            const confirmar = confirm(`Se importar谩n ${nuevosMovimientos.length} movimientos. 驴Agregar a los existentes?`);
            if (confirmar) {
                movimientos = [...movimientos, ...nuevosMovimientos];
                guardarDatosLocalStorage();
                actualizarTodo();
                mostrarMensaje(`${nuevosMovimientos.length} movimientos importados.`, 'exito');
            }
        }

        /**
         * Actualiza todas las secciones de la interfaz
         */
        function actualizarTodo() {
            actualizarResumen();
            actualizarTabla();
            actualizarObjetivoAhorro();
            actualizarFiltroCategorias();
            actualizarResumenCategorias();
            actualizarCategoriasFormulario();
            renderizarCategoriasPersonalizadas();
            actualizarGraficos();
            actualizarPresupuestos();
            actualizarRecurrentes();
            cargarCategoriasPresupuesto();
            renderizarCalendario();
        }

        /**
         * Exporta todos los datos a JSON (versi贸n completa)
         */
        function exportarJSON() {
            const datos = {
                movimientos,
                objetivoAhorro,
                categoriasPersonalizadas,
                presupuestos,
                movimientosRecurrentes,
                fechaExportacion: new Date().toISOString(),
                version: '2.0'
            };

            const json = JSON.stringify(datos, null, 2);
            descargarArchivo(json, 'finanzas_backup_completo.json', 'application/json');
            mostrarMensaje('Backup completo exportado.', 'exito');
        }
        
        // ==================== PWA - SERVICE WORKER ====================

        /**
         * Registra el Service Worker para funcionalidad offline
         */
        function registrarServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then((registration) => {
                            console.log('Service Worker registrado:', registration.scope);
                            
                            // Verificar actualizaciones
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // Hay una nueva versi贸n disponible
                                        if (confirm('Hay una nueva versi贸n disponible. 驴Deseas actualizar?')) {
                                            newWorker.postMessage({ type: 'SKIP_WAITING' });
                                            window.location.reload();
                                        }
                                    }
                                });
                            });
                        })
                        .catch((error) => {
                            console.log('Error al registrar Service Worker:', error);
                        });
                });
            }
        }

        /**
         * Solicita permiso para notificaciones (opcional)
         */
        function solicitarPermisoNotificaciones() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // ==================== PIN DE SEGURIDAD ====================

        /**
         * Verifica si hay PIN configurado y muestra el overlay si es necesario
         */
        function verificarPinSeguridad() {
            pinSeguridad = localStorage.getItem('finanzas_pin');
            pinConfigurado = pinSeguridad !== null;
            
            if (pinConfigurado) {
                document.getElementById('pin-overlay').classList.remove('oculto');
                document.getElementById('pin-1').focus();
            } else {
                document.getElementById('pin-overlay').classList.add('oculto');
            }
        }

        /**
         * Mueve el foco al siguiente input de PIN
         */
        function moverPinInput(numero) {
            const input = document.getElementById(`pin-${numero}`);
            if (input.value.length === 1 && numero < 4) {
                document.getElementById(`pin-${numero + 1}`).focus();
            }
            if (numero === 4 && input.value.length === 1) {
                verificarPin();
            }
        }

        /**
         * Maneja la tecla backspace en inputs de PIN
         */
        function manejarBackspacePin(event, numero) {
            if (event.key === 'Backspace' && numero > 1) {
                const input = document.getElementById(`pin-${numero}`);
                if (input.value === '') {
                    document.getElementById(`pin-${numero - 1}`).focus();
                }
            }
        }

        /**
         * Verifica el PIN ingresado
         */
        function verificarPin() {
            const pinIngresado = `${document.getElementById('pin-1').value}${document.getElementById('pin-2').value}${document.getElementById('pin-3').value}${document.getElementById('pin-4').value}`;
            
            if (pinIngresado === pinSeguridad) {
                document.getElementById('pin-overlay').classList.add('oculto');
                document.getElementById('pin-error').classList.remove('visible');
                // Limpiar inputs
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`pin-${i}`).value = '';
                }
            } else {
                document.getElementById('pin-error').classList.add('visible');
                // Limpiar inputs y enfocar primero
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`pin-${i}`).value = '';
                }
                document.getElementById('pin-1').focus();
            }
        }

        /**
         * Muestra el formulario para configurar/cambiar PIN
         */
        function mostrarConfigPin() {
            const nuevoPin = prompt('Ingresa un nuevo PIN de 4 d铆gitos (o deja vac铆o para eliminar):');
            
            if (nuevoPin === null) return;
            
            if (nuevoPin === '') {
                localStorage.removeItem('finanzas_pin');
                pinSeguridad = null;
                pinConfigurado = false;
                document.getElementById('pin-overlay').classList.add('oculto');
                mostrarToast('PIN eliminado', 'La protecci贸n por PIN ha sido desactivada', 'exito');
            } else if (/^\d{4}$/.test(nuevoPin)) {
                localStorage.setItem('finanzas_pin', nuevoPin);
                pinSeguridad = nuevoPin;
                pinConfigurado = true;
                document.getElementById('pin-overlay').classList.add('oculto');
                mostrarToast('PIN configurado', 'Tu nuevo PIN ha sido guardado', 'exito');
            } else {
                alert('El PIN debe ser exactamente 4 d铆gitos num茅ricos.');
            }
        }

        // ==================== NOTIFICACIONES TOAST ====================

        /**
         * Muestra una notificaci贸n toast
         */
        function mostrarToast(titulo, mensaje, tipo = 'advertencia') {
            const toast = document.getElementById('notificacion-toast');
            const iconos = {
                advertencia: '锔',
                exito: '',
                error: ''
            };
            
            document.querySelector('.toast-icono').textContent = iconos[tipo] || '';
            document.getElementById('toast-titulo').textContent = titulo;
            document.getElementById('toast-mensaje').textContent = mensaje;
            
            toast.className = `notificacion-toast visible ${tipo}`;
            
            // Auto-cerrar despu茅s de 5 segundos
            setTimeout(() => cerrarToast(), 5000);
        }

        /**
         * Cierra la notificaci贸n toast
         */
        function cerrarToast() {
            document.getElementById('notificacion-toast').classList.remove('visible');
        }

        /**
         * Verifica presupuestos excedidos y notifica
         */
        function verificarPresupuestosExcedidos() {
            const mesActual = new Date().getMonth();
            const anioActual = new Date().getFullYear();

            const gastosPorCategoria = {};
            movimientos.filter(m => {
                const fecha = new Date(m.fecha);
                return m.tipo === 'Gasto' && fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual;
            }).forEach(m => {
                gastosPorCategoria[m.categoria] = (gastosPorCategoria[m.categoria] || 0) + m.monto;
            });

            Object.entries(presupuestos).forEach(([categoria, limite]) => {
                const gastado = gastosPorCategoria[categoria] || 0;
                const porcentaje = (gastado / limite) * 100;
                
                if (porcentaje >= 100) {
                    mostrarToast(
                        `隆Presupuesto excedido!`,
                        `Has excedido el l铆mite de ${categoria} por ${formatearMoneda(gastado - limite)}`,
                        'error'
                    );
                } else if (porcentaje >= 80) {
                    mostrarToast(
                        `Presupuesto al l铆mite`,
                        `Has usado el ${porcentaje.toFixed(0)}% del presupuesto de ${categoria}`,
                        'advertencia'
                    );
                }
            });
        }

        // ==================== CALENDARIO ====================

        /**
         * Inicializa el calendario
         */
        function inicializarCalendario() {
            renderizarCalendario();
        }

        /**
         * Navega entre meses del calendario
         */
        function navegarCalendario(direccion) {
            if (direccion === 0) {
                calendarioMes = new Date().getMonth();
                calendarioAnio = new Date().getFullYear();
            } else {
                calendarioMes += direccion;
                if (calendarioMes > 11) {
                    calendarioMes = 0;
                    calendarioAnio++;
                } else if (calendarioMes < 0) {
                    calendarioMes = 11;
                    calendarioAnio--;
                }
            }
            renderizarCalendario();
        }

        /**
         * Renderiza el calendario completo
         */
        function renderizarCalendario() {
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            document.getElementById('calendario-titulo').textContent = 
                `${meses[calendarioMes]} ${calendarioAnio}`;

            const grid = document.getElementById('calendario-grid');
            grid.innerHTML = '';

            // Encabezados de d铆as
            const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi茅', 'Jue', 'Vie', 'S谩b'];
            diasSemana.forEach(dia => {
                const header = document.createElement('div');
                header.className = 'calendario-dia-header';
                header.textContent = dia;
                grid.appendChild(header);
            });

            // Primer d铆a del mes
            const primerDia = new Date(calendarioAnio, calendarioMes, 1);
            const ultimoDia = new Date(calendarioAnio, calendarioMes + 1, 0);
            const diasEnMes = ultimoDia.getDate();
            const diaSemanaInicio = primerDia.getDay();

            // D铆as del mes anterior
            const mesAnterior = new Date(calendarioAnio, calendarioMes, 0);
            const diasMesAnterior = mesAnterior.getDate();
            
            for (let i = diaSemanaInicio - 1; i >= 0; i--) {
                const dia = document.createElement('div');
                dia.className = 'calendario-dia otro-mes';
                dia.innerHTML = `<span class="numero">${diasMesAnterior - i}</span>`;
                grid.appendChild(dia);
            }

            // D铆as del mes actual
            const hoy = new Date();
            for (let i = 1; i <= diasEnMes; i++) {
                const dia = document.createElement('div');
                dia.className = 'calendario-dia';
                
                const fechaStr = `${calendarioAnio}-${String(calendarioMes + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                // Verificar si es hoy
                if (i === hoy.getDate() && calendarioMes === hoy.getMonth() && calendarioAnio === hoy.getFullYear()) {
                    dia.classList.add('hoy');
                }

                // Buscar movimientos de este d铆a
                const movsDia = movimientos.filter(m => m.fecha === fechaStr);
                const tieneIngresos = movsDia.some(m => m.tipo === 'Ingreso');
                const tieneGastos = movsDia.some(m => m.tipo === 'Gasto');

                let indicadoresHTML = '';
                if (tieneIngresos || tieneGastos) {
                    indicadoresHTML = '<div class="indicadores">';
                    if (tieneIngresos) indicadoresHTML += '<span class="indicador ingreso"></span>';
                    if (tieneGastos) indicadoresHTML += '<span class="indicador gasto"></span>';
                    indicadoresHTML += '</div>';
                }

                dia.innerHTML = `<span class="numero">${i}</span>${indicadoresHTML}`;
                dia.onclick = () => seleccionarDiaCalendario(fechaStr, i);
                
                grid.appendChild(dia);
            }

            // D铆as del mes siguiente
            const diasRestantes = 42 - (diaSemanaInicio + diasEnMes);
            for (let i = 1; i <= diasRestantes; i++) {
                const dia = document.createElement('div');
                dia.className = 'calendario-dia otro-mes';
                dia.innerHTML = `<span class="numero">${i}</span>`;
                grid.appendChild(dia);
            }
        }

        /**
         * Selecciona un d铆a del calendario y muestra sus movimientos
         */
        function seleccionarDiaCalendario(fechaStr, dia) {
            calendarioDiaSeleccionado = fechaStr;
            
            // Quitar selecci贸n anterior
            document.querySelectorAll('.calendario-dia.seleccionado').forEach(d => {
                d.classList.remove('seleccionado');
            });

            const movsDia = movimientos.filter(m => m.fecha === fechaStr);
            const detalle = document.getElementById('calendario-detalle');
            const lista = document.getElementById('calendario-detalle-lista');
            
            document.getElementById('calendario-detalle-fecha').textContent = 
                `Movimientos del ${formatearFecha(fechaStr)}`;

            if (movsDia.length === 0) {
                lista.innerHTML = '<p style="color: var(--color-texto-terciario);">No hay movimientos este d铆a.</p>';
            } else {
                lista.innerHTML = movsDia.map(m => `
                    <div class="calendario-detalle-item">
                        <span>${obtenerIconoCategoria(m.categoria)} ${m.categoria}</span>
                        <span class="${m.tipo === 'Ingreso' ? 'monto-positivo' : 'monto-negativo'}">
                            ${m.tipo === 'Ingreso' ? '+' : '-'}${formatearMoneda(m.monto)}
                        </span>
                    </div>
                `).join('');
            }

            detalle.classList.add('visible');
        }

        // ==================== EJECUCIN AUTOMTICA DE RECURRENTES ====================

        /**
         * Verifica y ejecuta movimientos recurrentes pendientes
         */
        function verificarYEjecutarRecurrentes() {
            const hoy = new Date();
            const diaHoy = hoy.getDate();
            const mesHoy = hoy.getMonth();
            const anioHoy = hoy.getFullYear();
            let ejecutados = 0;

            movimientosRecurrentes.forEach(r => {
                if (!r.activo) return;

                const ultimaEjecucion = r.ultimaEjecucion ? new Date(r.ultimaEjecucion) : null;
                let debeEjecutar = false;

                switch (r.frecuencia) {
                    case 'mensual':
                        if (diaHoy >= r.dia) {
                            if (!ultimaEjecucion || 
                                ultimaEjecucion.getMonth() !== mesHoy || 
                                ultimaEjecucion.getFullYear() !== anioHoy) {
                                debeEjecutar = true;
                            }
                        }
                        break;
                    case 'quincenal':
                        const diasQuincenales = [r.dia, r.dia + 15 > 28 ? 28 : r.dia + 15];
                        if (diasQuincenales.includes(diaHoy)) {
                            if (!ultimaEjecucion || ultimaEjecucion.toDateString() !== hoy.toDateString()) {
                                debeEjecutar = true;
                            }
                        }
                        break;
                    case 'semanal':
                        if (hoy.getDay() === (r.dia % 7)) {
                            if (!ultimaEjecucion || ultimaEjecucion.toDateString() !== hoy.toDateString()) {
                                debeEjecutar = true;
                            }
                        }
                        break;
                    case 'anual':
                        if (diaHoy === r.dia && mesHoy === (r.mesAnual || 0)) {
                            if (!ultimaEjecucion || ultimaEjecucion.getFullYear() !== anioHoy) {
                                debeEjecutar = true;
                            }
                        }
                        break;
                }

                if (debeEjecutar) {
                    // Ejecutar autom谩ticamente
                    const nuevoMovimiento = {
                        id: Date.now() + Math.random(),
                        tipo: r.tipo,
                        categoria: r.categoria,
                        monto: r.monto,
                        fecha: hoy.toISOString().split('T')[0],
                        descripcion: `${r.descripcion} (Auto-recurrente)`,
                        etiquetas: ['recurrente', 'automatico']
                    };

                    movimientos.push(nuevoMovimiento);
                    r.ultimaEjecucion = hoy.toISOString();
                    ejecutados++;
                }
            });

            if (ejecutados > 0) {
                guardarDatosLocalStorage();
                actualizarTodo();
                mostrarToast(
                    'Movimientos recurrentes',
                    `Se ejecutaron ${ejecutados} movimiento(s) recurrente(s) autom谩ticamente`,
                    'exito'
                );
            }
        }

        // ==================== GENERACIN DE REPORTES PDF ====================

        /**
         * Genera un reporte PDF del mes actual
         */
        function generarReportePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const mesActual = new Date().getMonth();
            const anioActual = new Date().getFullYear();
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            // T铆tulo
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text('Reporte de Finanzas Personales', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(100);
            doc.text(`${meses[mesActual]} ${anioActual}`, 105, 30, { align: 'center' });

            // Filtrar movimientos del mes
            const movimientosMes = movimientos.filter(m => {
                const fecha = new Date(m.fecha);
                return fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual;
            });

            // Calcular totales
            const ingresos = movimientosMes.filter(m => m.tipo === 'Ingreso')
                .reduce((sum, m) => sum + m.monto, 0);
            const gastos = movimientosMes.filter(m => m.tipo === 'Gasto')
                .reduce((sum, m) => sum + m.monto, 0);
            const balance = ingresos - gastos;

            // Resumen
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text('Resumen del Mes', 20, 45);
            
            doc.setFontSize(10);
            doc.setTextColor(39, 174, 96);
            doc.text(`Ingresos: ${formatearMoneda(ingresos)}`, 20, 55);
            doc.setTextColor(231, 76, 60);
            doc.text(`Gastos: ${formatearMoneda(gastos)}`, 20, 62);
            doc.setTextColor(balance >= 0 ? 39 : 231, balance >= 0 ? 174 : 76, balance >= 0 ? 96 : 60);
            doc.text(`Balance: ${formatearMoneda(balance)}`, 20, 69);

            // Tabla de movimientos
            if (movimientosMes.length > 0) {
                doc.setTextColor(0);
                doc.setFontSize(12);
                doc.text('Detalle de Movimientos', 20, 85);

                const datosTabla = movimientosMes.map(m => [
                    formatearFecha(m.fecha),
                    m.tipo,
                    m.categoria,
                    m.descripcion.substring(0, 30),
                    `${m.tipo === 'Ingreso' ? '+' : '-'}${formatearMoneda(m.monto)}`
                ]);

                doc.autoTable({
                    startY: 90,
                    head: [['Fecha', 'Tipo', 'Categor铆a', 'Descripci贸n', 'Monto']],
                    body: datosTabla,
                    theme: 'striped',
                    headStyles: { fillColor: [102, 126, 234] },
                    styles: { fontSize: 8 }
                });
            }

            // Gastos por categor铆a
            const gastosPorCategoria = {};
            movimientosMes.filter(m => m.tipo === 'Gasto').forEach(m => {
                gastosPorCategoria[m.categoria] = (gastosPorCategoria[m.categoria] || 0) + m.monto;
            });

            if (Object.keys(gastosPorCategoria).length > 0) {
                const startY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 15 : 100;
                doc.setFontSize(12);
                doc.text('Gastos por Categor铆a', 20, startY);

                const datosCategoria = Object.entries(gastosPorCategoria)
                    .sort((a, b) => b[1] - a[1])
                    .map(([cat, monto]) => [cat, formatearMoneda(monto)]);

                doc.autoTable({
                    startY: startY + 5,
                    head: [['Categor铆a', 'Total']],
                    body: datosCategoria,
                    theme: 'grid',
                    headStyles: { fillColor: [231, 76, 60] },
                    styles: { fontSize: 9 }
                });
            }

            // Pie de p谩gina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(
                    `Generado el ${new Date().toLocaleString('es-CO')} - P谩gina ${i} de ${pageCount}`,
                    105, 290, { align: 'center' }
                );
            }

            // Descargar
            doc.save(`reporte_finanzas_${meses[mesActual].toLowerCase()}_${anioActual}.pdf`);
            mostrarMensaje('Reporte PDF generado correctamente.', 'exito');
        }

        // ==================== FILE SYSTEM API - ARCHIVO LOCAL ====================

        // Variable para el handle del archivo
        let archivoHandle = null;
        let autoGuardadoActivo = false;

        /**
         * Guarda los datos en un archivo local usando File System Access API
         */
        async function guardarArchivoLocal() {
            // Verificar soporte
            if (!('showSaveFilePicker' in window)) {
                mostrarToast('No soportado', 'Tu navegador no soporta esta funci贸n. Usa Chrome o Edge.', 'error');
                return;
            }

            try {
                // Si no hay handle o queremos elegir nuevo archivo
                if (!archivoHandle) {
                    archivoHandle = await window.showSaveFilePicker({
                        suggestedName: 'finanzas_datos.json',
                        types: [{
                            description: 'Archivo JSON',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                }

                // Preparar datos
                const datos = {
                    movimientos,
                    objetivoAhorro,
                    categoriasPersonalizadas,
                    presupuestos,
                    movimientosRecurrentes,
                    fechaGuardado: new Date().toISOString(),
                    version: '2.0'
                };

                // Escribir en archivo
                const writable = await archivoHandle.createWritable();
                await writable.write(JSON.stringify(datos, null, 2));
                await writable.close();

                // Actualizar estado
                const nombreArchivo = archivoHandle.name;
                document.getElementById('archivo-texto').textContent = `Guardado: ${nombreArchivo}`;
                document.getElementById('archivo-status').className = 'sync-status sincronizado';
                
                mostrarToast('隆Guardado!', `Datos guardados en ${nombreArchivo}`, 'exito');

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error guardando archivo:', error);
                    mostrarToast('Error', 'No se pudo guardar el archivo', 'error');
                }
            }
        }

        /**
         * Carga datos desde un archivo local usando File System Access API
         */
        async function cargarArchivoLocal() {
            // Verificar soporte
            if (!('showOpenFilePicker' in window)) {
                mostrarToast('No soportado', 'Tu navegador no soporta esta funci贸n. Usa Chrome o Edge.', 'error');
                return;
            }

            try {
                const [handle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'Archivo JSON',
                        accept: { 'application/json': ['.json'] }
                    }]
                });

                archivoHandle = handle;
                const file = await handle.getFile();
                const contenido = await file.text();
                const datos = JSON.parse(contenido);

                // Confirmar antes de reemplazar
                if (confirm(`驴Cargar datos desde "${file.name}"? Esto reemplazar谩 tus datos actuales.`)) {
                    movimientos = datos.movimientos || [];
                    objetivoAhorro = datos.objetivoAhorro || 0;
                    categoriasPersonalizadas = datos.categoriasPersonalizadas || { Ingreso: [], Gasto: [], Ahorro: [] };
                    presupuestos = datos.presupuestos || {};
                    movimientosRecurrentes = datos.movimientosRecurrentes || [];

                    guardarDatosLocalStorage();
                    actualizarTodo();

                    document.getElementById('archivo-texto').textContent = `Vinculado: ${file.name}`;
                    document.getElementById('archivo-status').className = 'sync-status sincronizado';

                    mostrarToast('隆Cargado!', `Datos restaurados desde ${file.name}`, 'exito');
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error cargando archivo:', error);
                    mostrarToast('Error', 'No se pudo cargar el archivo', 'error');
                }
            }
        }

        /**
         * Activa/desactiva el auto-guardado en archivo local
         */
        function toggleAutoGuardadoArchivo() {
            autoGuardadoActivo = document.getElementById('auto-guardar-archivo').checked;
            
            if (autoGuardadoActivo && !archivoHandle) {
                mostrarToast('Sin archivo', 'Primero guarda en un archivo para activar auto-guardado', 'advertencia');
                document.getElementById('auto-guardar-archivo').checked = false;
                autoGuardadoActivo = false;
                return;
            }

            if (autoGuardadoActivo) {
                mostrarToast('Auto-guardado', 'Se guardar谩 autom谩ticamente en cada cambio', 'exito');
            }
        }

        /**
         * Guarda autom谩ticamente si est谩 activo
         */
        function autoGuardarSiActivo() {
            if (autoGuardadoActivo && archivoHandle) {
                guardarArchivoLocal();
            }
        }

        // ==================== GITHUB GIST API ====================

        /**
         * Muestra/oculta el token de GitHub
         */
        function toggleVerToken() {
            const input = document.getElementById('github-token');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        /**
         * Muestra ayuda sobre c贸mo obtener token de GitHub
         */
        function mostrarAyudaGitHub() {
            const ayuda = `
 CMO OBTENER UN TOKEN DE GITHUB:

1. Ve a github.com e inicia sesi贸n
2. Haz clic en tu foto de perfil  Settings
3. En el men煤 izquierdo, baja hasta "Developer settings"
4. Haz clic en "Personal access tokens"  "Tokens (classic)"
5. Clic en "Generate new token"  "Generate new token (classic)"
6. Dale un nombre descriptivo como "Finanzas App"
7. Selecciona solo el permiso "gist"
8. Clic en "Generate token"
9. 隆COPIA EL TOKEN INMEDIATAMENTE! Solo se muestra una vez

El token se ver谩 as铆: ghp_xxxxxxxxxxxxxxxxxxxx

锔 IMPORTANTE: Guarda el token en un lugar seguro
            `;
            alert(ayuda);
        }

        /**
         * Guarda la configuraci贸n de GitHub en localStorage
         */
        function guardarConfigGitHub() {
            const token = document.getElementById('github-token').value.trim();
            const gistId = document.getElementById('gist-id').value.trim();

            if (!token) {
                mostrarToast('Token requerido', 'Ingresa un token de GitHub', 'error');
                return;
            }

            localStorage.setItem('finanzas_github_token', token);
            if (gistId) {
                localStorage.setItem('finanzas_gist_id', gistId);
            }

            document.getElementById('github-texto').textContent = 'Configurado ';
            document.getElementById('github-status').className = 'sync-status sincronizado';
            
            mostrarToast('隆Guardado!', 'Configuraci贸n de GitHub guardada', 'exito');
        }

        /**
         * Carga la configuraci贸n de GitHub desde localStorage
         */
        function cargarConfigGitHub() {
            const token = localStorage.getItem('finanzas_github_token');
            const gistId = localStorage.getItem('finanzas_gist_id');

            if (token) {
                document.getElementById('github-token').value = token;
                document.getElementById('github-texto').textContent = 'Configurado ';
                document.getElementById('github-status').className = 'sync-status sincronizado';
            }
            if (gistId) {
                document.getElementById('gist-id').value = gistId;
            }
        }

        /**
         * Sincroniza los datos con GitHub Gist
         */
        async function sincronizarGitHub() {
            const token = localStorage.getItem('finanzas_github_token');
            let gistId = localStorage.getItem('finanzas_gist_id');

            if (!token) {
                mostrarToast('Sin configurar', 'Primero configura tu token de GitHub', 'error');
                return;
            }

            // Mostrar estado
            document.getElementById('github-texto').textContent = 'Sincronizando...';
            document.getElementById('github-status').className = 'sync-status sincronizando';

            // Preparar datos
            const datos = {
                movimientos,
                objetivoAhorro,
                categoriasPersonalizadas,
                presupuestos,
                movimientosRecurrentes,
                fechaSincronizacion: new Date().toISOString(),
                version: '2.0'
            };

            const contenidoArchivo = JSON.stringify(datos, null, 2);

            try {
                let response;

                if (gistId) {
                    // Actualizar Gist existente
                    response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                'finanzas_backup.json': {
                                    content: contenidoArchivo
                                }
                            }
                        })
                    });
                } else {
                    // Crear nuevo Gist
                    response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: 'Backup de Finanzas Personales',
                            public: false,
                            files: {
                                'finanzas_backup.json': {
                                    content: contenidoArchivo
                                }
                            }
                        })
                    });
                }

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const resultado = await response.json();

                // Guardar el ID del Gist para futuras sincronizaciones
                if (!gistId) {
                    localStorage.setItem('finanzas_gist_id', resultado.id);
                    document.getElementById('gist-id').value = resultado.id;
                }

                // Actualizar estado
                const fecha = new Date().toLocaleString('es-CO');
                document.getElementById('github-texto').textContent = `Sincronizado: ${fecha}`;
                document.getElementById('github-status').className = 'sync-status sincronizado';

                mostrarToast('隆Sincronizado!', 'Datos guardados en GitHub Gist', 'exito');

            } catch (error) {
                console.error('Error sincronizando con GitHub:', error);
                document.getElementById('github-texto').textContent = 'Error de sincronizaci贸n';
                document.getElementById('github-status').className = 'sync-status error';
                mostrarToast('Error', 'No se pudo sincronizar con GitHub. Verifica tu token.', 'error');
            }
        }

        /**
         * Carga datos desde GitHub Gist
         */
        async function cargarDesdeGitHub() {
            const token = localStorage.getItem('finanzas_github_token');
            const gistId = localStorage.getItem('finanzas_gist_id');

            if (!token || !gistId) {
                mostrarToast('Sin configurar', 'Configura tu token y sincroniza primero', 'error');
                return;
            }

            document.getElementById('github-texto').textContent = 'Descargando...';

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const gist = await response.json();
                const contenido = gist.files['finanzas_backup.json']?.content;

                if (!contenido) {
                    throw new Error('Archivo no encontrado en el Gist');
                }

                const datos = JSON.parse(contenido);

                if (confirm('驴Descargar datos desde GitHub? Esto reemplazar谩 tus datos actuales.')) {
                    movimientos = datos.movimientos || [];
                    objetivoAhorro = datos.objetivoAhorro || 0;
                    categoriasPersonalizadas = datos.categoriasPersonalizadas || { Ingreso: [], Gasto: [], Ahorro: [] };
                    presupuestos = datos.presupuestos || {};
                    movimientosRecurrentes = datos.movimientosRecurrentes || [];

                    guardarDatosLocalStorage();
                    actualizarTodo();

                    const fecha = new Date().toLocaleString('es-CO');
                    document.getElementById('github-texto').textContent = `Descargado: ${fecha}`;

                    mostrarToast('隆Descargado!', 'Datos restaurados desde GitHub', 'exito');
                } else {
                    document.getElementById('github-texto').textContent = 'Configurado ';
                }

            } catch (error) {
                console.error('Error cargando desde GitHub:', error);
                document.getElementById('github-texto').textContent = 'Error al descargar';
                document.getElementById('github-status').className = 'sync-status error';
                mostrarToast('Error', 'No se pudo descargar desde GitHub', 'error');
            }
        }

        // ==================== INICIAR APLICACIN ====================
        
        // Ejecutar inicializaci贸n cuando el DOM est茅 listo
        document.addEventListener('DOMContentLoaded', () => {
            inicializar();
            registrarServiceWorker();
            configurarAtajosTeclado();
        });

        // ==================== ATAJOS DE TECLADO ====================

        /**
         * Configura los atajos de teclado globales
         */
        function configurarAtajosTeclado() {
            document.addEventListener('keydown', (e) => {
                // No activar atajos si estamos en un input/textarea
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    // Solo Escape para cerrar modales
                    if (e.key === 'Escape') {
                        cerrarModalEditar();
                        cerrarAyudaAtajos();
                    }
                    return;
                }

                // Ctrl/Cmd + tecla
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key.toLowerCase()) {
                        case 'n': // Nuevo movimiento
                            e.preventDefault();
                            document.getElementById('tipo').focus();
                            document.getElementById('tipo').scrollIntoView({ behavior: 'smooth', block: 'center' });
                            break;
                        case 's': // Guardar/Sincronizar
                            e.preventDefault();
                            sincronizarNube();
                            break;
                        case 'e': // Exportar CSV
                            e.preventDefault();
                            exportarCSV();
                            break;
                        case 'p': // Generar PDF
                            e.preventDefault();
                            generarReportePDF();
                            break;
                        case 'f': // Enfocar b煤squeda
                            e.preventDefault();
                            document.getElementById('filtro-busqueda').focus();
                            document.getElementById('filtro-busqueda').scrollIntoView({ behavior: 'smooth', block: 'center' });
                            break;
                    }
                }

                // Teclas sin modificador
                switch (e.key) {
                    case '?': // Mostrar ayuda de atajos
                        e.preventDefault();
                        toggleAyudaAtajos();
                        break;
                    case 'Escape': // Cerrar modales/ayuda
                        cerrarModalEditar();
                        cerrarAyudaAtajos();
                        break;
                    case '1': // Ir a resumen
                        if (!e.ctrlKey && !e.metaKey) {
                            document.querySelector('.resumen').scrollIntoView({ behavior: 'smooth' });
                        }
                        break;
                    case '2': // Ir a formulario
                        if (!e.ctrlKey && !e.metaKey) {
                            document.getElementById('formulario-movimiento').scrollIntoView({ behavior: 'smooth' });
                        }
                        break;
                    case '3': // Ir a tabla
                        if (!e.ctrlKey && !e.metaKey) {
                            document.getElementById('tabla-movimientos').scrollIntoView({ behavior: 'smooth' });
                        }
                        break;
                    case '4': // Ir a gr谩ficos
                        if (!e.ctrlKey && !e.metaKey) {
                            document.getElementById('grafico-gastos').scrollIntoView({ behavior: 'smooth' });
                        }
                        break;
                }
            });
        }

        /**
         * Muestra/oculta el panel de ayuda de atajos
         */
        function toggleAyudaAtajos() {
            let ayuda = document.getElementById('shortcuts-help');
            if (!ayuda) {
                ayuda = crearPanelAyudaAtajos();
            }
            ayuda.classList.toggle('visible');
        }

        /**
         * Cierra el panel de ayuda de atajos
         */
        function cerrarAyudaAtajos() {
            const ayuda = document.getElementById('shortcuts-help');
            if (ayuda) {
                ayuda.classList.remove('visible');
            }
        }

        /**
         * Crea el panel de ayuda de atajos de teclado
         */
        function crearPanelAyudaAtajos() {
            const ayuda = document.createElement('div');
            ayuda.id = 'shortcuts-help';
            ayuda.className = 'shortcuts-help';
            ayuda.innerHTML = `
                <h4>锔 Atajos de Teclado</h4>
                <ul>
                    <li><span>Nuevo movimiento</span><kbd>Ctrl+N</kbd></li>
                    <li><span>Buscar</span><kbd>Ctrl+F</kbd></li>
                    <li><span>Exportar CSV</span><kbd>Ctrl+E</kbd></li>
                    <li><span>Generar PDF</span><kbd>Ctrl+P</kbd></li>
                    <li><span>Sincronizar</span><kbd>Ctrl+S</kbd></li>
                    <li><span>Ir al resumen</span><kbd>1</kbd></li>
                    <li><span>Ir al formulario</span><kbd>2</kbd></li>
                    <li><span>Ir a movimientos</span><kbd>3</kbd></li>
                    <li><span>Ir a gr谩ficos</span><kbd>4</kbd></li>
                    <li><span>Cerrar modal</span><kbd>Esc</kbd></li>
                    <li><span>Esta ayuda</span><kbd>?</kbd></li>
                </ul>
                <button class="btn btn-secundario btn-pequeno" onclick="cerrarAyudaAtajos()" style="width: 100%; margin-top: 10px;">Cerrar</button>
            `;
            document.body.appendChild(ayuda);
            
            // Tambi茅n crear bot贸n flotante de ayuda
            const btnAyuda = document.createElement('button');
            btnAyuda.className = 'btn-ayuda-flotante';
            btnAyuda.innerHTML = '?';
            btnAyuda.setAttribute('aria-label', 'Ver atajos de teclado');
            btnAyuda.onclick = toggleAyudaAtajos;
            document.body.appendChild(btnAyuda);
            
            return ayuda;
        }
    </script>

</body>
</html>
